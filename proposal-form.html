<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Genrate Client Proposals</title>
    <script src="/config.js"></script>
    <script src="/proposal-config.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f7fa;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.12);
            max-width: 900px;
            width: 100%;
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #1a2a4a 0%, #253550 100%);
            padding: 48px 40px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: relative;
        }

        .header-content {
            flex: 1;
        }

        .header h1 {
            color: white;
            font-size: 28px;
            font-weight: 600;
            letter-spacing: -0.5px;
            margin: 0;
        }

        .header p {
            color: rgba(255, 255, 255, 0.8);
            margin: 8px 0 0 0;
            font-size: 15px;
        }

        .header-logo {
            flex-shrink: 0;
        }

        .header-logo img {
            max-width: 280px;
            height: auto;
            filter: brightness(0) invert(1);
        }

        .form-container {
            padding: 48px 40px;
        }

        .section {
            margin-bottom: 40px;
            padding-bottom: 32px;
            border-bottom: 1px solid #e0e6ed;
        }

        .section:last-child {
            border-bottom: none;
        }

        .section-title {
            font-size: 20px;
            color: #1a2a4a;
            margin-bottom: 24px;
            font-weight: 600;
            letter-spacing: -0.3px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            margin-bottom: 28px;
        }

        .form-group label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: #1a2a4a;
            margin-bottom: 10px;
            letter-spacing: 0.3px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid #e0e6ed;
            border-radius: 8px;
            font-size: 15px;
            color: #1a2a4a;
            background: white;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #1a2a4a;
            box-shadow: 0 0 0 3px rgba(26, 42, 74, 0.1);
            background: white;
        }

        .form-group input::placeholder,
        .form-group textarea::placeholder {
            color: #9ca3af;
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
            font-family: inherit;
        }

        .service-item {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 16px;
            border: 1px solid #e0e6ed;
            transition: all 0.3s ease;
        }

        .service-item:hover {
            border-color: #1a2a4a;
            box-shadow: 0 2px 8px rgba(26, 42, 74, 0.08);
        }

        .service-item.active {
            border-color: #1a2a4a;
            background: white;
            box-shadow: 0 0 0 3px rgba(26, 42, 74, 0.1);
        }

        .service-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .service-header input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-right: 12px;
            cursor: pointer;
            accent-color: #1a2a4a;
        }

        .service-header label {
            font-weight: 600;
            font-size: 15px;
            color: #1a2a4a;
            cursor: pointer;
            flex: 1;
            letter-spacing: -0.2px;
        }

        .service-details {
            display: none;
            margin-left: 32px;
            margin-top: 15px;
        }

        .service-item.active .service-details {
            display: grid;
            gap: 15px;
        }

        .inline-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .price-display {
            background: #f0f3f8;
            padding: 12px 16px;
            border-radius: 8px;
            font-weight: 600;
            color: #1a2a4a;
            text-align: center;
            border: 1px solid #e0e6ed;
        }

        .button-group {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-top: 32px;
        }

        button {
            padding: 14px 32px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #1a2a4a 0%, #253550 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(26, 42, 74, 0.3);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: #f0f3f8;
            color: #1a2a4a;
            border: 1px solid #e0e6ed;
        }

        .btn-secondary:hover {
            background: #e8ecf2;
        }

        .summary-box {
            background: linear-gradient(135deg, #1a2a4a 0%, #253550 100%);
            color: white;
            padding: 32px;
            border-radius: 12px;
            margin-top: 24px;
            box-shadow: 0 8px 24px rgba(26, 42, 74, 0.2);
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 16px;
            font-size: 16px;
        }

        .summary-row.total {
            font-size: 24px;
            font-weight: 700;
            padding-top: 16px;
            border-top: 2px solid rgba(255, 255, 255, 0.3);
            margin-top: 8px;
        }

        .helper-text {
            font-size: 13px;
            color: #9ca3af;
            margin-top: 6px;
        }

        /* Bullet point management */
        .bullets-container {
            background: #f9fafb;
            border: 1px solid #e0e6ed;
            border-radius: 6px;
            padding: 12px;
            max-height: 300px;
            overflow-y: auto;
        }

        .bullet-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .bullet-item {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            margin-bottom: 8px;
            padding: 8px;
            background: white;
            border-radius: 4px;
            border: 1px solid #e0e6ed;
        }

        .bullet-item.sub-bullet {
            margin-left: 32px;
            background: #f0f3f8;
        }

        .bullet-marker {
            font-size: 12px;
            color: #6b7280;
            min-width: 16px;
            margin-top: 4px;
        }

        .bullet-item.sub-bullet .bullet-marker {
            color: #9ca3af;
        }

        .bullet-input {
            flex: 1;
            border: none;
            background: transparent;
            font-size: 14px;
            padding: 4px;
            font-family: inherit;
        }

        .bullet-input:focus {
            outline: none;
            background: #fffbeb;
            border-radius: 3px;
        }

        .bullet-controls {
            display: flex;
            gap: 4px;
        }

        .bullet-control-btn {
            padding: 4px 8px;
            border: none;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
        }

        .bullet-control-btn.add-sub {
            background: #10b981;
            color: white;
        }

        .bullet-control-btn.add-sub:hover {
            background: #059669;
        }

        .bullet-control-btn.delete {
            background: #ef4444;
            color: white;
        }

        .bullet-control-btn.delete:hover {
            background: #dc2626;
        }

        .add-bullet-btn {
            width: 100%;
            padding: 8px;
            background: #10b981;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 8px;
        }

        .add-bullet-btn:hover {
            background: #059669;
        }

        .default-bullets {
            background: #f0f9ff;
            border: 1px solid #bae6fd;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 12px;
        }

        .default-bullets-title {
            font-size: 12px;
            font-weight: 600;
            color: #0369a1;
            margin-bottom: 8px;
        }

        .default-bullets ul {
            list-style: disc;
            padding-left: 20px;
            margin: 0;
        }

        .default-bullets li {
            font-size: 13px;
            color: #374151;
            margin-bottom: 4px;
        }

        .json-output {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            border-radius: 10px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            margin-top: 20px;
            display: none;
        }

        .json-output.show {
            display: block;
        }

        .copy-btn {
            background: #4caf50;
            color: white;
            padding: 8px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 10px;
        }

        .copy-btn:hover {
            background: #45a049;
        }

        .image-item {
            background: #f9fafb;
            border: 2px dashed #e0e6ed;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 16px;
            position: relative;
            transition: all 0.3s ease;
        }

        .image-item:hover {
            border-color: #1a2a4a;
            background: white;
        }

        .image-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .image-item-title {
            font-weight: 600;
            color: #1a2a4a;
            font-size: 15px;
        }

        .remove-image-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s ease;
        }

        .remove-image-btn:hover {
            background: #dc2626;
        }

        .image-upload-area {
            border: 2px dashed #cbd5e1;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
            margin-bottom: 16px;
        }

        .image-upload-area:hover {
            border-color: #1a2a4a;
            background: #f9fafb;
        }

        .image-upload-area.has-image {
            border-color: #10b981;
            background: #f0fdf4;
        }

        .image-preview {
            max-width: 200px;
            max-height: 150px;
            margin: 10px auto;
            display: none;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .image-preview.show {
            display: block;
        }

        .image-upload-text {
            color: #64748b;
            font-size: 14px;
        }

        .image-upload-icon {
            font-size: 32px;
            margin-bottom: 8px;
        }

        /* Auto-save indicator */
        .autosave-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(26, 42, 74, 0.95);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 14px;
            display: none;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .autosave-indicator.show {
            display: flex;
        }

        .autosave-indicator.saving {
            background: rgba(59, 130, 246, 0.95);
        }

        .autosave-indicator.saved {
            background: rgba(16, 185, 129, 0.95);
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column-reverse;
                align-items: flex-start;
                gap: 20px;
                padding: 30px 20px;
            }

            .header-logo img {
                max-width: 150px;
            }

            .form-content {
                padding: 25px;
            }

            .inline-group {
                grid-template-columns: 1fr;
            }

            .button-group {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-content">
                <h1>Proposal Generator</h1>
                <p>Client Proposal Generation Form</p>
            </div>
            <div class="header-logo">
                <img src="logo.png" alt="ExposeProfi Logo">
            </div>
        </div>

        <form id="proposalForm" class="form-container">
            <!-- Client Information -->
            <div class="section">
                <h2 class="section-title">üë§ Client Information</h2>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="clientNumber">Client Number</label>
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <input type="text" id="clientNumber" placeholder="e.g. 12345" style="flex: 1;">
                            <button type="button" id="fetchClientBtn" style="padding: 10px 16px; background: #1a2a4a; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; min-width: 40px; transition: background 0.2s;" title="Fetch company name">‚úì</button>
                        </div>
                        <span class="helper-text">Enter 5-digit client number and click ‚úì to fetch company name</span>
                    </div>
                    <div class="form-group" id="companyNameGroup">
                        <label for="companyName">Company Name *</label>
                        <input type="text" id="companyName" required placeholder="Auto-filled from database" readonly style="background: #f5f7fa; cursor: not-allowed;">
                    </div>
                    <div class="form-group">
                        <label for="street">Address *</label>
                        <input type="text" id="street" required placeholder="e.g. Sample Street 123">
                    </div>
                    <div class="form-group">
                        <label for="postalCode">Postal Code *</label>
                        <input type="text" id="postalCode" required placeholder="e.g. 12345">
                    </div>
                    <div class="form-group">
                        <label for="city">City *</label>
                        <input type="text" id="city" required placeholder="e.g. Berlin">
                    </div>
                    <div class="form-group">
                        <label for="country">Country *</label>
                        <select id="country" required>
                            <option value="">Select Country</option>
                            <option value="Deutschland">Deutschland</option>
                            <option value="√ñsterreich">√ñsterreich</option>
                            <option value="Schweiz">Schweiz</option>
                            <option value="Frankreich">Frankreich</option>
                            <option value="Italien">Italien</option>
                            <option value="Spanien">Spanien</option>
                            <option value="Niederlande">Niederlande</option>
                            <option value="Belgien">Belgien</option>
                            <option value="Polen">Polen</option>
                            <option value="Tschechien">Tschechien</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Project Information -->
            <div class="section">
                <h2 class="section-title">üè¢ Project Information</h2>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="projectNumber">Project Number</label>
                        <input type="text" id="projectNumber" placeholder="e.g. PRJ-2025-042">
                        <span class="helper-text">Optional: Internal project reference number</span>
                    </div>
                    <div class="form-group">
                        <label for="projectName">Project Name</label>
                        <input type="text" id="projectName" placeholder="e.g. Sunshine Residential Complex">
                    </div>
                    <div class="form-group">
                        <label for="projectType">Project Type *</label>
                        <select id="projectType" required>
                            <option value="">Select Project Type...</option>
                        </select>
                    </div>
                    <div class="form-group" id="customProjectTypeGroup" style="display:none;">
                        <label for="customProjectType">Custom Project Type</label>
                        <input type="text" id="customProjectType" placeholder="Enter custom project type">
                    </div>
                    <div class="form-group">
                        <label for="deliveryTime">Delivery Time *</label>
                        <input type="text" id="deliveryTime" required readonly value="Calculated automatically" style="background: #f5f7fa; cursor: not-allowed;">
                        <span class="helper-text">Auto-calculated based on selected services</span>
                    </div>
                    <input type="hidden" id="deliveryDaysMin" value="0">
                    <input type="hidden" id="deliveryDaysMax" value="0">
                    <div class="form-group">
                        <label for="offerValidUntil">Offer Valid Until *</label>
                        <input type="date" id="offerValidUntil" required>
                    </div>
                </div>
            </div>

            <!-- Services Section -->
            <div class="section">
                <h2 class="section-title">üé® Select Services</h2>

                <!-- 3D Exterior Ground Perspective -->
                <div class="service-item" id="service-exterior-ground">
                    <div class="service-header">
                        <input type="checkbox" id="check-exterior-ground">
                        <label for="check-exterior-ground">3D-Au√üenvisualisierung Bodenperspektive</label>
                    </div>
                    <div class="service-details">
                        <div class="form-group">
                            <label>Building Type *</label>
                            <select class="building-type-input" data-service="exterior-ground" required>
                                <option value="">Select Building Type...</option>
                                <option value="EFH">EFH (Einfamilienhaus)</option>
                                <option value="DHH">DHH & MFH (2-5 WE)</option>
                                <option value="MFH-6-10">MFH (6-10 WE)</option>
                                <option value="MFH-11-15">MFH (11-15 WE)</option>
                            </select>
                            <span class="helper-text">Select building type for pricing</span>
                        </div>
                        <div class="form-group">
                            <label>Number of Views *</label>
                            <input type="number" class="quantity-input" data-service="exterior-ground" min="0" value="0">
                            <span class="helper-text">Price varies by building type and number of views</span>
                        </div>
                        <div class="form-group">
                            <label>Custom Unit Price (Optional)</label>
                            <input type="number" class="custom-price-input" data-service="exterior-ground" min="0" step="0.01" placeholder="Leave empty for default price">
                            <span class="helper-text">Override default price per unit (in ‚Ç¨)</span>
                        </div>
                        <div class="form-group">
                            <label>Description Details (Optional)</label>
                            <div class="default-bullets">
                                <div class="default-bullets-title">Default Description:</div>
                                <ul>
                                    <li>Fotorealistische 3D-Visualisierung aus Bodenperspektive</li>
                                    <li>Hochaufl√∂sende Darstellung (min. 3000px)</li>
                                    <li>Professionelle Lichtsetzung und Materialisierung</li>
                                    <li>Umgebungsgestaltung mit Vegetation und Kontext</li>
                                </ul>
                            </div>
                            <div class="form-group">
                                <label>Custom Description (Optional)</label>
                                <textarea class="custom-description-textarea" data-service="exterior-ground" rows="6" placeholder="Enter custom bullet points (one per line)&#10;&#10;Example:&#10;Main bullet point&#10;- Sub-bullet point&#10;-- Sub-sub-bullet point"></textarea>
                                <span class="helper-text">One bullet per line. Use - for sub-bullets, -- for sub-sub-bullets</span>
                            </div>
                        </div>
                        <div class="price-display">
                            <span>Price: <strong><span class="service-price" data-service="exterior-ground">0,00 ‚Ç¨</span></strong></span>
                        </div>
                    </div>
                </div>

                <!-- 3D Exterior Bird's Eye View -->
                <div class="service-item" id="service-exterior-bird">
                    <div class="service-header">
                        <input type="checkbox" id="check-exterior-bird">
                        <label for="check-exterior-bird">3D-Au√üenvisualisierung Vogelperspektive</label>
                    </div>
                    <div class="service-details">
                        <div class="form-group">
                            <label>Number of Views *</label>
                            <input type="number" class="quantity-input" data-service="exterior-bird" min="0" value="0">
                            <span class="helper-text">Price: 12,00 ‚Ç¨ per view (only with ground perspectives)</span>
                        </div>
                        <div class="form-group">
                            <label>Custom Unit Price (Optional)</label>
                            <input type="number" class="custom-price-input" data-service="exterior-bird" min="0" step="0.01" placeholder="Leave empty for default price">
                            <span class="helper-text">Override default price per unit (in ‚Ç¨)</span>
                        </div>
                        <div class="form-group">
                            <label>Description Details (Optional)</label>
                            <textarea class="custom-description-textarea" data-service="exterior-bird" rows="6" placeholder="Enter custom bullet points (one per line)&#10;&#10;Example:&#10;Main bullet point&#10;- Sub-bullet point&#10;-- Sub-sub-bullet point"></textarea>
                            <span class="helper-text">Add custom description points or leave empty for default</span>
                        </div>
                        <div class="price-display">
                            <span>Price: <strong><span class="service-price" data-service="exterior-bird">0,00 ‚Ç¨</span></strong></span>
                        </div>
                    </div>
                </div>

                <!-- 3D Floor Plan -->
                <div class="service-item" id="service-3d-floorplan">
                    <div class="service-header">
                        <input type="checkbox" id="check-3d-floorplan">
                        <label for="check-3d-floorplan">3D-Grundriss</label>
                    </div>
                    <div class="service-details">
                        <div class="form-group">
                            <label>Project Type *</label>
                            <select class="project-type-input" data-service="3d-floorplan" required>
                                <option value="">Select Project Type...</option>
                                <option value="residential">Residential (69‚Ç¨ per plan)</option>
                                <option value="commercial">Commercial (Price by area size)</option>
                            </select>
                            <span class="helper-text">Select residential or commercial project</span>
                        </div>
                        <div class="form-group commercial-only" style="display: none;" data-service="3d-floorplan">
                            <label>Area Size (Fl√§che) *</label>
                            <select class="area-size-input" data-service="3d-floorplan">
                                <option value="">Select Area Size...</option>
                                <option value="100">100 sqm - 99‚Ç¨</option>
                                <option value="250">250 sqm - 199‚Ç¨</option>
                                <option value="500">500 sqm - 299‚Ç¨</option>
                                <option value="1000">1000 sqm - 399‚Ç¨</option>
                                <option value="1500">1500 sqm - 499‚Ç¨</option>
                            </select>
                            <span class="helper-text">Select area size for commercial pricing</span>
                        </div>
                        <div class="form-group">
                            <label>Number of Floor Plans *</label>
                            <input type="number" class="quantity-input" data-service="3d-floorplan" min="0" value="0">
                            <span class="helper-text">Price varies by project type</span>
                        </div>
                        <div class="form-group">
                            <label>Custom Unit Price (Optional)</label>
                            <input type="number" class="custom-price-input" data-service="3d-floorplan" min="0" step="0.01" placeholder="Leave empty for default price">
                            <span class="helper-text">Override default price per unit (in ‚Ç¨)</span>
                        </div>
                        <div class="form-group">
                            <label>Description Details (Optional)</label>
                            <textarea class="custom-description-textarea" data-service="3d-floorplan" rows="6" placeholder="Enter custom bullet points (one per line)&#10;&#10;Example:&#10;Main bullet point&#10;- Sub-bullet point&#10;-- Sub-sub-bullet point"></textarea>
                            <span class="helper-text">Add custom description points or leave empty for default</span>
                        </div>
                        <div class="price-display">
                            <span>Price: <strong><span class="service-price" data-service="3d-floorplan">0,00 ‚Ç¨</span></strong></span>
                        </div>
                    </div>
                </div>
                <!-- 3D Complete Floor View -->
                <div class="service-item" id="service-3d-complete-floor">
                    <div class="service-header">
                        <input type="checkbox" id="check-3d-complete-floor">
                        <label for="check-3d-complete-floor">3D-Geschossansicht</label>
                    </div>
                    <div class="service-details">
                        <div class="form-group">
                            <label>Number of Floor Views *</label>
                            <input type="number" class="quantity-input" data-service="3d-complete-floor" min="0" value="0">
                            <span class="helper-text">Price: 199,00 ‚Ç¨ per floor</span>
                        </div>
                        <div class="form-group">
                            <label>Custom Unit Price (Optional)</label>
                            <input type="number" class="custom-price-input" data-service="3d-complete-floor" min="0" step="0.01" placeholder="Leave empty for default price">
                            <span class="helper-text">Override default price per unit (in ‚Ç¨)</span>
                        </div>
                        <div class="form-group">
                            <label>Description Details (Optional)</label>
                            <textarea class="custom-description-textarea" data-service="3d-complete-floor" rows="6" placeholder="Enter custom bullet points (one per line)&#10;&#10;Example:&#10;EG - Ground floor&#10;1. OG - First floor&#10;- Sub-bullet point&#10;-- Sub-sub-bullet point"></textarea>
                            <span class="helper-text">Add custom description points or leave empty for default</span>
                        </div>
                        <div class="price-display">
                            <span>Price: <strong><span class="service-price" data-service="3d-complete-floor">0,00 ‚Ç¨</span></strong></span>
                        </div>
                    </div>
                </div>

                <!-- 2D Floor Plan -->
                <div class="service-item" id="service-2d-floorplan">
                    <div class="service-header">
                        <input type="checkbox" id="check-2d-floorplan">
                        <label for="check-2d-floorplan">2D-Grundriss</label>
                    </div>
                    <div class="service-details">
                        <div class="form-group">
                            <label>Project Type *</label>
                            <select class="project-type-input" data-service="2d-floorplan" required>
                                <option value="">Select Project Type...</option>
                                <option value="residential">Residential (49‚Ç¨ per plan)</option>
                                <option value="commercial">Commercial (Price by area size)</option>
                            </select>
                            <span class="helper-text">Select residential or commercial project</span>
                        </div>
                        <div class="form-group commercial-only" style="display: none;" data-service="2d-floorplan">
                            <label>Area Size (Fl√§che) *</label>
                            <select class="area-size-input" data-service="2d-floorplan">
                                <option value="">Select Area Size...</option>
                                <option value="100">100 sqm - 39‚Ç¨</option>
                                <option value="250">250 sqm - 79‚Ç¨</option>
                                <option value="500">500 sqm - 119‚Ç¨</option>
                                <option value="1000">1000 sqm - 159‚Ç¨</option>
                                <option value="1500">1500 sqm - 199‚Ç¨</option>
                            </select>
                            <span class="helper-text">Select area size for commercial pricing</span>
                        </div>
                        <div class="form-group">
                            <label>Number of Floor Plans *</label>
                            <input type="number" class="quantity-input" data-service="2d-floorplan" min="0" value="0">
                            <span class="helper-text">Price varies by project type</span>
                        </div>
                        <div class="form-group">
                            <label>Custom Unit Price (Optional)</label>
                            <input type="number" class="custom-price-input" data-service="2d-floorplan" min="0" step="0.01" placeholder="Leave empty for default price">
                            <span class="helper-text">Override default price per unit (in ‚Ç¨)</span>
                        </div>
                        <div class="form-group">
                            <label>Description Details (Optional)</label>
                            <textarea class="custom-description-textarea" data-service="2d-floorplan" rows="6" placeholder="Enter custom bullet points (one per line)&#10;&#10;Example:&#10;Main bullet point&#10;- Sub-bullet point&#10;-- Sub-sub-bullet point"></textarea>
                            <span class="helper-text">Add custom description points or leave empty for default</span>
                        </div>
                        <div class="price-display">
                            <span>Price: <strong><span class="service-price" data-service="2d-floorplan">0,00 ‚Ç¨</span></strong></span>
                        </div>
                    </div>
                </div>

                <!-- Digital Home Staging -->
                <div class="service-item" id="service-home-staging">
                    <div class="service-header">
                        <input type="checkbox" id="check-home-staging">
                        <label for="check-home-staging">Digital Home Staging</label>
                    </div>
                    <div class="service-details">
                        <div class="form-group">
                            <label>Number of Photos *</label>
                            <input type="number" class="quantity-input" data-service="home-staging" min="0" value="0">
                            <span class="helper-text">Price: 99,00 ‚Ç¨ per photo</span>
                        </div>
                        <div class="form-group">
                            <label>Custom Unit Price (Optional)</label>
                            <input type="number" class="custom-price-input" data-service="home-staging" min="0" step="0.01" placeholder="Leave empty for default price">
                            <span class="helper-text">Override default price per unit (in ‚Ç¨)</span>
                        </div>
                        <div class="form-group">
                            <label>Description Details (Optional)</label>
                            <textarea class="custom-description-textarea" data-service="home-staging" rows="6" placeholder="Enter custom bullet points (one per line)&#10;&#10;Example:&#10;Wohnzimmer - Living room&#10;K√ºche - Kitchen&#10;- Sub-bullet point"></textarea>
                            <span class="helper-text">Add custom description points or leave empty for default</span>
                        </div>
                        <div class="price-display">
                            <span>Price: <strong><span class="service-price" data-service="home-staging">0,00 ‚Ç¨</span></strong></span>
                        </div>
                    </div>
                </div>

                <!-- Digital Renovation -->
                <div class="service-item" id="service-renovation">
                    <div class="service-header">
                        <input type="checkbox" id="check-renovation">
                        <label for="check-renovation">Digitale Renovierung</label>
                    </div>
                    <div class="service-details">
                        <div class="form-group">
                            <label>Number of Photos *</label>
                            <input type="number" class="quantity-input" data-service="renovation" min="0" value="0">
                            <span class="helper-text">Price: 139,00 ‚Ç¨ per photo</span>
                        </div>
                        <div class="form-group">
                            <label>Custom Unit Price (Optional)</label>
                            <input type="number" class="custom-price-input" data-service="renovation" min="0" step="0.01" placeholder="Leave empty for default price">
                            <span class="helper-text">Override default price per unit (in ‚Ç¨)</span>
                        </div>
                        <div class="form-group">
                            <label>Description Details (Optional)</label>
                            <textarea class="custom-description-textarea" data-service="renovation" rows="6" placeholder="Enter custom bullet points (one per line)&#10;&#10;Example:&#10;Bad - Bathroom&#10;K√ºche - Kitchen&#10;- Sub-bullet point"></textarea>
                            <span class="helper-text">Add custom description points or leave empty for default</span>
                        </div>
                        <div class="price-display">
                            <span>Price: <strong><span class="service-price" data-service="renovation">0,00 ‚Ç¨</span></strong></span>
                        </div>
                    </div>
                </div>

                <!-- 360¬∞ Interior Tour -->
                <div class="service-item" id="service-360-interior">
                    <div class="service-header">
                        <input type="checkbox" id="check-360-interior">
                        <label for="check-360-interior">360¬∞ Tour Innen (Virtuelle Tour)</label>
                    </div>
                    <div class="service-details">
                        <div class="form-group">
                            <label>Apartment Size *</label>
                            <select class="apartment-size-input" data-service="360-interior" required>
                                <option value="">Select Apartment Size...</option>
                                <option value="30">bis 30 m¬≤</option>
                                <option value="40">Etwa 40 m¬≤</option>
                                <option value="50">Etwa 50 m¬≤</option>
                                <option value="60">Etwa 60 m¬≤</option>
                                <option value="70">Etwa 70 m¬≤</option>
                                <option value="80">Etwa 80 m¬≤</option>
                                <option value="90">90 m¬≤ bis 100 m¬≤</option>
                                <option value="100">100 m¬≤ bis 120 m¬≤</option>
                                <option value="EFH">EFH und DHH</option>
                            </select>
                            <span class="helper-text">Select apartment size for pricing</span>
                        </div>
                        <div class="form-group">
                            <label>Number of Tours *</label>
                            <input type="number" class="quantity-input" data-service="360-interior" min="0" value="0">
                            <span class="helper-text">Price varies by apartment size</span>
                        </div>
                        <div class="form-group">
                            <label>Custom Unit Price (Optional)</label>
                            <input type="number" class="custom-price-input" data-service="360-interior" min="0" step="0.01" placeholder="Leave empty for default price">
                            <span class="helper-text">Override default price per unit (in ‚Ç¨)</span>
                        </div>
                        <div class="form-group">
                            <label>Description Details (Optional)</label>
                            <textarea class="custom-description-textarea" data-service="360-interior" rows="6" placeholder="Enter custom bullet points (one per line)&#10;&#10;Example:&#10;Apt. 1.02&#10;Penthouse&#10;- Sub-bullet point"></textarea>
                            <span class="helper-text">Add custom description points or leave empty for default</span>
                        </div>
                        <div class="price-display">
                            <span>Price: <strong><span class="service-price" data-service="360-interior">0,00 ‚Ç¨</span></strong></span>
                        </div>
                    </div>
                </div>

                <!-- 360¬∞ Exterior Video -->
                <div class="service-item" id="service-360-exterior">
                    <div class="service-header">
                        <input type="checkbox" id="check-360-exterior">
                        <label for="check-360-exterior">Video Au√üen</label>
                    </div>
                    <div class="service-details">
                        <div class="form-group">
                            <label>Building Type *</label>
                            <select class="building-type-input" data-service="360-exterior" required>
                                <option value="">Select Building Type...</option>
                                <option value="EFH-DHH">EFH & DHH</option>
                                <option value="MFH-3-5">MFH (3-5 WE)</option>
                                <option value="MFH-6-10">MFH (6-10 WE)</option>
                                <option value="MFH-11-15">MFH (11-15 WE)</option>
                            </select>
                            <span class="helper-text">Select building type for pricing</span>
                        </div>
                        <div class="form-group">
                            <label>Number of Videos *</label>
                            <input type="number" class="quantity-input" data-service="360-exterior" min="0" value="0">
                            <span class="helper-text">Price varies by building type</span>
                        </div>
                        <div class="form-group">
                            <label>Custom Unit Price (Optional)</label>
                            <input type="number" class="custom-price-input" data-service="360-exterior" min="0" step="0.01" placeholder="Leave empty for default price">
                            <span class="helper-text">Override default price per unit (in ‚Ç¨)</span>
                        </div>
                        <div class="form-group">
                            <label>Description Details (Optional)</label>
                            <textarea class="custom-description-textarea" data-service="360-exterior" rows="6" placeholder="Enter custom bullet points (one per line)&#10;&#10;Example:&#10;Main bullet point&#10;- Sub-bullet point&#10;-- Sub-sub-bullet point"></textarea>
                            <span class="helper-text">Add custom description points or leave empty for default</span>
                        </div>
                        <div class="price-display">
                            <span>Price: <strong><span class="service-price" data-service="360-exterior">0,00 ‚Ç¨</span></strong></span>
                        </div>
                    </div>
                </div>

                <!-- Slideshow Video -->
                <div class="service-item" id="service-slideshow">
                    <div class="service-header">
                        <input type="checkbox" id="check-slideshow">
                        <label for="check-slideshow">Slideshow Video</label>
                    </div>
                    <div class="service-details">
                        <div class="form-group">
                            <label>Number of Videos *</label>
                            <input type="number" class="quantity-input" data-service="slideshow" min="0" value="0">
                            <span class="helper-text">Price: 499,00 ‚Ç¨ per video</span>
                        </div>
                        <div class="form-group">
                            <label>Custom Unit Price (Optional)</label>
                            <input type="number" class="custom-price-input" data-service="slideshow" min="0" step="0.01" placeholder="Leave empty for default price">
                            <span class="helper-text">Override default price per unit (in ‚Ç¨)</span>
                        </div>
                        <div class="form-group">
                            <label>Description Details (Optional)</label>
                            <textarea class="custom-description-textarea" data-service="slideshow" rows="6" placeholder="Enter custom bullet points (one per line)&#10;&#10;Example:&#10;Main bullet point&#10;- Sub-bullet point&#10;-- Sub-sub-bullet point"></textarea>
                            <span class="helper-text">Add custom description points or leave empty for default</span>
                        </div>
                        <div class="price-display">
                            <span>Price: <strong><span class="service-price" data-service="slideshow">0,00 ‚Ç¨</span></strong></span>
                        </div>
                    </div>
                </div>

                <!-- 3D Site Plan -->
                <div class="service-item" id="service-site-plan">
                    <div class="service-header">
                        <input type="checkbox" id="check-site-plan">
                        <label for="check-site-plan">3D-Lageplan</label>
                    </div>
                    <div class="service-details">
                        <div class="form-group">
                            <label>Number of Site Plans *</label>
                            <input type="number" class="quantity-input" data-service="site-plan" min="0" value="0">
                            <span class="helper-text">Price: 99,00 ‚Ç¨ per site plan</span>
                        </div>
                        <div class="form-group">
                            <label>Custom Unit Price (Optional)</label>
                            <input type="number" class="custom-price-input" data-service="site-plan" min="0" step="0.01" placeholder="Leave empty for default price">
                            <span class="helper-text">Override default price per unit (in ‚Ç¨)</span>
                        </div>
                        <div class="form-group">
                            <label>Description Details (Optional)</label>
                            <textarea class="custom-description-textarea" data-service="site-plan" rows="6" placeholder="Enter custom bullet points (one per line)&#10;&#10;Example:&#10;Main bullet point&#10;- Sub-bullet point&#10;-- Sub-sub-bullet point"></textarea>
                            <span class="helper-text">Add custom description points or leave empty for default</span>
                        </div>
                        <div class="price-display">
                            <span>Price: <strong><span class="service-price" data-service="site-plan">0,00 ‚Ç¨</span></strong></span>
                        </div>
                    </div>
                </div>

                <!-- Social Media Package -->
                <div class="service-item" id="service-social-media">
                    <div class="service-header">
                        <input type="checkbox" id="check-social-media">
                        <label for="check-social-media">Social Media Paket</label>
                    </div>
                    <div class="service-details">
                        <div class="form-group">
                            <label>Number of Packages *</label>
                            <input type="number" class="quantity-input" data-service="social-media" min="0" value="0">
                            <span class="helper-text">Price: 299,00 ‚Ç¨ per package</span>
                        </div>
                        <div class="form-group">
                            <label>Custom Unit Price (Optional)</label>
                            <input type="number" class="custom-price-input" data-service="social-media" min="0" step="0.01" placeholder="Leave empty for default price">
                            <span class="helper-text">Override default price per unit (in ‚Ç¨)</span>
                        </div>
                        <div class="form-group">
                            <label>Description Details (Optional)</label>
                            <textarea class="custom-description-textarea" data-service="social-media" rows="6" placeholder="Enter custom bullet points (one per line)&#10;&#10;Example:&#10;Main bullet point&#10;- Sub-bullet point&#10;-- Sub-sub-bullet point"></textarea>
                            <span class="helper-text">Add custom description points or leave empty for default</span>
                        </div>
                        <div class="price-display">
                            <span>Price: <strong><span class="service-price" data-service="social-media">0,00 ‚Ç¨</span></strong></span>
                        </div>
                    </div>
                </div>

                <!-- 3D Interior Visualization -->
                <div class="service-item" id="service-interior">
                    <div class="service-header">
                        <input type="checkbox" id="check-interior">
                        <label for="check-interior">3D-Innenvisualisierung</label>
                    </div>
                    <div class="service-details">
                        <div class="form-group">
                            <label>Number of Views *</label>
                            <input type="number" class="quantity-input" data-service="interior" min="0" value="0">
                            <span class="helper-text">Tiered pricing: 1=399‚Ç¨, 2=299‚Ç¨, 3=289‚Ç¨, 4=269‚Ç¨, 5=259‚Ç¨, 6=249‚Ç¨, 7=239‚Ç¨, 8=229‚Ç¨, 9=219‚Ç¨, 10+=199‚Ç¨</span>
                        </div>
                        <div class="form-group">
                            <label>Custom Unit Price (Optional)</label>
                            <input type="number" class="custom-price-input" data-service="interior" min="0" step="0.01" placeholder="Leave empty for default price">
                            <span class="helper-text">Override default price per unit (in ‚Ç¨)</span>
                        </div>
                        <div class="form-group">
                            <label>Description Details (Optional)</label>
                            <textarea class="custom-description-textarea" data-service="interior" rows="6" placeholder="Enter custom bullet points (one per line)&#10;&#10;Example:&#10;Wohnzimmer - Living room&#10;K√ºche - Kitchen&#10;- Sub-bullet point"></textarea>
                            <span class="helper-text">Add custom description points or leave empty for default</span>
                        </div>
                        <div class="price-display">
                            <span>Price: <strong><span class="service-price" data-service="interior">0,00 ‚Ç¨</span></strong></span>
                        </div>
                    </div>
                </div>

                <!-- 3D Terrace Visualization -->
                <div class="service-item" id="service-terrace">
                    <div class="service-header">
                        <input type="checkbox" id="check-terrace">
                        <label for="check-terrace">3D-Visualisierung Terrasse</label>
                    </div>
                    <div class="service-details">
                        <div class="form-group">
                            <label>Number of Views *</label>
                            <input type="number" class="quantity-input" data-service="terrace" min="0" value="0">
                            <span class="helper-text">Preis nach Anfrage</span>
                        </div>
                        <div class="form-group">
                            <label>Custom Unit Price (Optional)</label>
                            <input type="number" class="custom-price-input" data-service="terrace" min="0" step="0.01" placeholder="Leave empty for default price">
                            <span class="helper-text">Override default price per unit (in ‚Ç¨)</span>
                        </div>
                        <div class="form-group">
                            <label>Description Details (Optional)</label>
                            <textarea class="custom-description-textarea" data-service="terrace" rows="6" placeholder="Enter custom bullet points (one per line)&#10;&#10;Example:&#10;Terrasse Apt. 2.03&#10;Rooftop terrace&#10;- Sub-bullet point"></textarea>
                            <span class="helper-text">Add custom description points or leave empty for default</span>
                        </div>
                        <div class="price-display">
                            <span>Price: <strong><span class="service-price" data-service="terrace">0,00 ‚Ç¨</span></strong></span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Perspective Images Section -->
            <div class="section">
                <h2 class="section-title">üñºÔ∏è Perspective Images (Recommended Perspectives)</h2>
                <p class="helper-text" style="margin-bottom: 20px;">Add images with titles and descriptions that will be included on the second-to-last page of the proposal.</p>
                
                <div id="imagesContainer">
                    <!-- Image items will be added here dynamically -->
                </div>
                
                <button type="button" class="btn-secondary" onclick="addImageField()" style="margin-top: 16px;">
                    ‚ûï Add Image
                </button>
            </div>

            <!-- Discount Section -->
            <div class="section">
                <h2 class="section-title">üí∏ Discount (Optional)</h2>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="discountType">Discount Type</label>
                        <select id="discountType">
                            <option value="">No Discount</option>
                            <option value="percentage">Percentage (%)</option>
                            <option value="fixed">Fixed Amount (EUR)</option>
                        </select>
                    </div>
                    <div class="form-group" id="discountAmountGroup" style="display:none;">
                        <label for="discountAmount">Discount Value</label>
                        <input type="number" id="discountAmount" placeholder="0" step="0.01" min="0">
                        <span class="helper-text" id="discountHelper">Enter discount value</span>
                    </div>
                    <div class="form-group" id="discountDescGroup" style="display:none;" style="grid-column: 1 / -1;">
                        <label for="discountDescription">Discount Description</label>
                        <input type="text" id="discountDescription" placeholder="e.g. Mengenrabatt, Sonderaktion">
                    </div>
                </div>
            </div>

            <!-- Summary -->
            <div class="section">
                <h2 class="section-title">üí∞ Summary</h2>
                <div class="summary-box">
                    <div class="summary-row">
                        <span>Subtotal Net:</span>
                        <span id="subtotalNet">0,00 ‚Ç¨</span>
                    </div>
                    <div class="summary-row" id="discountRow" style="display:none;">
                        <span>Discount (<span id="discountDisplayType"></span>):</span>
                        <span id="discountDisplay">0,00 ‚Ç¨</span>
                    </div>
                    <div class="summary-row">
                        <span>Total Net Price:</span>
                        <span id="totalNet">0,00 ‚Ç¨</span>
                    </div>
                    <div class="summary-row">
                        <span>VAT (19%):</span>
                        <span id="totalVat">0,00 ‚Ç¨</span>
                    </div>
                    <div class="summary-row total">
                        <span>Total Gross Price:</span>
                        <span id="totalGross">0,00 ‚Ç¨</span>
                    </div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="button-group">
                <button type="button" class="btn-secondary" onclick="resetForm()">üîÑ Reset</button>
                <button type="button" class="btn-primary" onclick="generateJSON()">üìã Generate JSON</button>
                <button type="button" class="btn-primary" onclick="previewProposal()">üëÅÔ∏è Preview Proposal</button>
            </div>

            <!-- JSON Output -->
            <div id="jsonOutput" class="json-output"></div>
            <button type="button" class="copy-btn" id="copyBtn" style="display: none;" onclick="copyJSON()">üìã Copy JSON</button>
        </form>
    </div>

    <!-- Auto-save Indicator -->
    <div id="autosaveIndicator" class="autosave-indicator">
        <span id="autosaveIcon">üíæ</span>
        <span id="autosaveText">Saved</span>
    </div>

    <script>
        // ========== DATA PERSISTENCE ==========
        const STORAGE_KEY = 'proposalFormData';
        const AUTOSAVE_INTERVAL = 5000; // Auto-save every 5 seconds
        let autoSaveTimer = null;

        // Load saved data on page load
        function loadSavedData() {
            const savedData = localStorage.getItem(STORAGE_KEY);
            if (!savedData) return;

            try {
                const data = JSON.parse(savedData);
                console.log('Loading saved form data...');

                // Restore client information
                if (data.clientInfo) {
                    document.getElementById('clientNumber').value = data.clientInfo.clientNumber || '';
                    document.getElementById('companyName').value = data.clientInfo.companyName || '';
                    document.getElementById('street').value = data.clientInfo.street || '';
                    document.getElementById('postalCode').value = data.clientInfo.postalCode || '';
                    document.getElementById('city').value = data.clientInfo.city || '';
                    document.getElementById('country').value = data.clientInfo.country || '';
                }

                // Restore project information
                if (data.projectInfo) {
                    document.getElementById('projectNumber').value = data.projectInfo.projectNumber || '';
                    document.getElementById('projectName').value = data.projectInfo.projectName || '';
                    document.getElementById('unitCount').value = data.projectInfo.unitCount || '';
                    document.getElementById('deliveryDays').value = data.projectInfo.deliveryDays || '14';
                    if (data.projectInfo.offerValidUntil) {
                        document.getElementById('offerValidUntil').value = data.projectInfo.offerValidUntil;
                    }
                }

                // Restore services
                if (data.services) {
                    data.services.forEach(savedService => {
                        const serviceItem = findServiceItemByName(savedService.name);
                        if (serviceItem) {
                            const checkbox = serviceItem.querySelector('input[type="checkbox"]');
                            const quantityInput = serviceItem.querySelector('.quantity-input');
                            
                            if (checkbox) {
                                checkbox.checked = true;
                                serviceItem.classList.add('active');
                            }
                            
                            if (quantityInput && savedService.quantity) {
                                quantityInput.value = savedService.quantity;
                            }
                            
                            // Restore custom price if present
                            if (savedService.customPrice && quantityInput) {
                                const serviceId = quantityInput.dataset.service;
                                const customPriceInput = serviceItem.querySelector(`.custom-price-input[data-service="${serviceId}"]`);
                                if (customPriceInput) {
                                    customPriceInput.value = savedService.customPrice;
                                }
                            }
                            
                            // Restore building type if present
                            if (savedService.buildingType && quantityInput) {
                                const serviceId = quantityInput.dataset.service;
                                const buildingTypeSelect = serviceItem.querySelector(`.building-type-input[data-service="${serviceId}"]`);
                                if (buildingTypeSelect) {
                                    buildingTypeSelect.value = savedService.buildingType;
                                }
                            }
                            
                            // Restore apartment size if present
                            if (savedService.apartmentSize && quantityInput) {
                                const serviceId = quantityInput.dataset.service;
                                const apartmentSizeSelect = serviceItem.querySelector(`.apartment-size-input[data-service="${serviceId}"]`);
                                if (apartmentSizeSelect) {
                                    apartmentSizeSelect.value = savedService.apartmentSize;
                                }
                            }
                            
                            // Restore project type and area size if present
                            if (savedService.projectType && quantityInput) {
                                const serviceId = quantityInput.dataset.service;
                                const projectTypeSelect = serviceItem.querySelector(`.project-type-input[data-service="${serviceId}"]`);
                                if (projectTypeSelect) {
                                    projectTypeSelect.value = savedService.projectType;
                                    // Show/hide commercial fields
                                    const commercialField = serviceItem.querySelector(`.commercial-only[data-service="${serviceId}"]`);
                                    if (commercialField) {
                                        commercialField.style.display = savedService.projectType === 'commercial' ? 'block' : 'none';
                                    }
                                }
                            }
                            
                            if (savedService.areaSize && quantityInput) {
                                const serviceId = quantityInput.dataset.service;
                                const areaSizeSelect = serviceItem.querySelector(`.area-size-input[data-service="${serviceId}"]`);
                                if (areaSizeSelect) {
                                    areaSizeSelect.value = savedService.areaSize;
                                }
                            }
                            
                            // Restore custom descriptions to textarea
                            if (savedService.customDescription && quantityInput) {
                                const serviceId = quantityInput.dataset.service;
                                const textarea = document.querySelector(`.custom-description-textarea[data-service="${serviceId}"]`);
                                if (textarea) {
                                    // Convert array back to textarea format with dash hierarchy
                                    const lines = [];
                                    savedService.customDescription.forEach(item => {
                                        if (typeof item === 'object' && item.text) {
                                            lines.push(item.text);
                                            if (item.children && item.children.length > 0) {
                                                item.children.forEach(child => {
                                                    if (typeof child === 'object' && child.text) {
                                                        lines.push('- ' + child.text);
                                                        if (child.children && child.children.length > 0) {
                                                            child.children.forEach(subchild => {
                                                                lines.push('-- ' + (typeof subchild === 'object' ? subchild.text : subchild));
                                                            });
                                                        }
                                                    } else {
                                                        lines.push('- ' + child);
                                                    }
                                                });
                                            }
                                        } else {
                                            lines.push(item);
                                        }
                                    });
                                    textarea.value = lines.join('\n');
                                }
                            }
                        }
                    });
                }

                updateCalculations();
                console.log('‚úÖ Form data restored from localStorage');
            } catch (error) {
                console.error('Error loading saved data:', error);
            }
        }

        // Find service item by service name
        function findServiceItemByName(serviceName) {
            const serviceItems = document.querySelectorAll('.service-item');
            for (const item of serviceItems) {
                const label = item.querySelector('.service-header label');
                if (label && label.textContent.trim() === serviceName) {
                    return item;
                }
            }
            return null;
        }

        // Save form data to localStorage
        function saveFormData() {
            try {
                showSaveIndicator();
                const data = collectFormData();
                
                // Create a copy without image data to avoid localStorage quota
                const dataToSave = {
                    ...data,
                    images: data.images.map(img => ({
                        title: img.title,
                        description: img.description,
                        fileName: img.fileName,
                        fileSize: img.fileSize,
                        fileType: img.fileType
                        // Exclude imageData from localStorage
                    }))
                };
                
                localStorage.setItem(STORAGE_KEY, JSON.stringify(dataToSave));
                console.log('üíæ Form data auto-saved');
                showSavedIndicator();
            } catch (error) {
                console.error('Error saving form data:', error);
                // If still quota exceeded, try clearing old data
                if (error.name === 'QuotaExceededError') {
                    console.warn('‚ö†Ô∏è Storage quota exceeded. Skipping auto-save.');
                    showSavedIndicator(); // Still show saved to avoid confusion
                }
            }
        }

        // Start auto-save
        function startAutoSave() {
            if (autoSaveTimer) clearInterval(autoSaveTimer);
            
            autoSaveTimer = setInterval(() => {
                saveFormData();
            }, AUTOSAVE_INTERVAL);
        }

        // Clear saved data
        function clearSavedData() {
            localStorage.removeItem(STORAGE_KEY);
            localStorage.removeItem('proposalPreviewData');
            console.log('üóëÔ∏è Saved form data cleared');
        }

        // Add save indicator
        function showSaveIndicator() {
            const indicator = document.getElementById('autosaveIndicator');
            const icon = document.getElementById('autosaveIcon');
            const text = document.getElementById('autosaveText');
            
            indicator.classList.remove('saved');
            indicator.classList.add('saving', 'show');
            icon.textContent = '‚è≥';
            text.textContent = 'Saving...';
        }

        // Show saved indicator
        function showSavedIndicator() {
            const indicator = document.getElementById('autosaveIndicator');
            const icon = document.getElementById('autosaveIcon');
            const text = document.getElementById('autosaveText');
            
            indicator.classList.remove('saving');
            indicator.classList.add('saved', 'show');
            icon.textContent = '‚úÖ';
            text.textContent = 'Saved';
            
            // Hide after 2 seconds
            setTimeout(() => {
                indicator.classList.remove('show');
            }, 2000);
        }

        // ========== END DATA PERSISTENCE ==========

        // Pricing tiers
        const pricing = {
            'exterior-ground': (qty, buildingType) => {
                if (qty === 0) return 0;
                if (!buildingType) return 0;
                
                // Pricing matrix: [1x, 2x, 3x, 4x, 5x+]
                const priceMatrix = {
                    'EFH': [499, 349, 299, 229, 199],
                    'DHH': [599, 399, 359, 329, 299],
                    'MFH-6-10': [699, 499, 399, 349, 329],
                    'MFH-11-15': [799, 599, 499, 399, 349]
                };
                
                const prices = priceMatrix[buildingType] || [0, 0, 0, 0, 0];
                if (qty <= 5) return prices[qty - 1];
                return prices[4]; // 5+
            },
            'exterior-bird': () => 12,
            '3d-floorplan': (projectType, areaSize) => {
                if (projectType === 'commercial') {
                    const commercialPrices = { '100': 99, '250': 199, '500': 299, '1000': 399, '1500': 499 };
                    return commercialPrices[areaSize] || 0;
                }
                return 69; // Residential
            },
            '3d-complete-floor': () => 199,
            '2d-floorplan': (projectType, areaSize) => {
                if (projectType === 'commercial') {
                    const commercialPrices = { '100': 39, '250': 79, '500': 119, '1000': 159, '1500': 199 };
                    return commercialPrices[areaSize] || 0;
                }
                return 49; // Residential
            },
            'home-staging': () => 99,
            'renovation': () => 139,
            '360-interior': (apartmentSize) => {
                if (!apartmentSize) return 0;
                const prices = {
                    '30': 999, '40': 1299, '50': 1499, '60': 1699,
                    '70': 1799, '80': 1899, '90': 1999, '100': 2299, 'EFH': 2499
                };
                return prices[apartmentSize] || 0;
            },
            '360-exterior': (buildingType) => {
                if (!buildingType) return 0;
                const prices = {
                    'EFH-DHH': 1299, 'MFH-3-5': 1299, 'MFH-6-10': 1699, 'MFH-11-15': 1999
                };
                return prices[buildingType] || 0;
            },
            'slideshow': () => 499,
            'site-plan': () => 99,
            'social-media': () => 299,
            'interior': (qty) => {
                if (qty === 0) return 0;
                if (qty === 1) return 399;
                if (qty === 2) return 299;
                if (qty === 3) return 289;
                if (qty === 4) return 269;
                if (qty === 5) return 259;
                if (qty === 6) return 249;
                if (qty === 7) return 239;
                if (qty === 8) return 229;
                if (qty === 9) return 219;
                return 199; // 10+
            },
            'terrace': () => 0 // Price on request
        };

        // Toggle service selection
        document.querySelectorAll('.service-header input[type="checkbox"]').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                const serviceItem = this.closest('.service-item');
                if (this.checked) {
                    serviceItem.classList.add('active');
                } else {
                    serviceItem.classList.remove('active');
                    // Reset quantity
                    const quantityInput = serviceItem.querySelector('.quantity-input');
                    if (quantityInput) quantityInput.value = 0;
                    updateCalculations();
                }
                saveFormData(); // Auto-save on service change
            });
        });

        // Update calculations on quantity change
        document.querySelectorAll('.quantity-input').forEach(input => {
            input.addEventListener('input', function() {
                updateCalculations();
                saveFormData(); // Auto-save on quantity change
            });
        });

        // Update calculations on building type/apartment size/project type/area size change
        document.querySelectorAll('.building-type-input, .apartment-size-input, .project-type-input, .area-size-input').forEach(select => {
            select.addEventListener('change', function() {
                // Show/hide commercial area size fields
                if (this.classList.contains('project-type-input')) {
                    const service = this.dataset.service;
                    const commercialField = document.querySelector(`.commercial-only[data-service="${service}"]`);
                    if (commercialField) {
                        commercialField.style.display = this.value === 'commercial' ? 'block' : 'none';
                    }
                }
                updateCalculations();
                saveFormData();
            });
        });

        // Update calculations on custom price change
        document.querySelectorAll('.custom-price-input').forEach(input => {
            input.addEventListener('input', function() {
                updateCalculations();
                saveFormData();
            });
        });

        // Add auto-save to all input fields
        document.querySelectorAll('input, select, textarea').forEach(field => {
            field.addEventListener('change', saveFormData);
        });

        function updateCalculations() {
            let subtotalNet = 0;

            document.querySelectorAll('.quantity-input').forEach(input => {
                const service = input.dataset.service;
                const quantity = parseInt(input.value) || 0;
                const priceFunc = pricing[service];
                
                // Check if custom price is provided
                const customPriceInput = document.querySelector(`.custom-price-input[data-service="${service}"]`);
                const customPrice = customPriceInput ? parseFloat(customPriceInput.value) : null;
                
                if (priceFunc) {
                    let unitPrice, serviceTotal;
                    
                    // Use custom price if provided, otherwise calculate from pricing function
                    if (customPrice && customPrice > 0) {
                        unitPrice = customPrice;
                        serviceTotal = unitPrice * quantity;
                    } else {
                        // Get additional parameters based on service type
                        if (service === 'exterior-ground') {
                            const buildingType = document.querySelector(`.building-type-input[data-service="${service}"]`)?.value;
                            unitPrice = priceFunc(quantity, buildingType);
                            serviceTotal = unitPrice * quantity;
                        } else if (service === '360-interior') {
                            const apartmentSize = document.querySelector(`.apartment-size-input[data-service="${service}"]`)?.value;
                            unitPrice = priceFunc(apartmentSize);
                            serviceTotal = unitPrice * quantity;
                        } else if (service === '360-exterior') {
                            const buildingType = document.querySelector(`.building-type-input[data-service="${service}"]`)?.value;
                            unitPrice = priceFunc(buildingType);
                            serviceTotal = unitPrice * quantity;
                        } else if (service === '3d-floorplan' || service === '2d-floorplan') {
                            const projectType = document.querySelector(`.project-type-input[data-service="${service}"]`)?.value;
                            const areaSize = document.querySelector(`.area-size-input[data-service="${service}"]`)?.value;
                            unitPrice = priceFunc(projectType, areaSize);
                            serviceTotal = unitPrice * quantity;
                        } else if (service === 'interior') {
                            unitPrice = priceFunc(quantity);
                            serviceTotal = unitPrice * quantity;
                        } else {
                            unitPrice = priceFunc();
                            serviceTotal = unitPrice * quantity;
                        }
                    }
                    
                    // Update service price display
                    const priceDisplay = document.querySelector(`.service-price[data-service="${service}"]`);
                    if (priceDisplay) {
                        priceDisplay.textContent = formatPrice(serviceTotal);
                    }
                    
                    subtotalNet += serviceTotal;
                }
            });

            // Update subtotal
            document.getElementById('subtotalNet').textContent = formatPrice(subtotalNet);

            // Calculate discount
            let discountAmount = 0;
            const discountType = document.getElementById('discountType').value;
            const discountValue = parseFloat(document.getElementById('discountAmount').value) || 0;
            
            if (discountType && discountValue > 0) {
                if (discountType === 'percentage') {
                    discountAmount = subtotalNet * (discountValue / 100);
                    document.getElementById('discountDisplayType').textContent = discountValue + '%';
                } else if (discountType === 'fixed') {
                    discountAmount = discountValue;
                    document.getElementById('discountDisplayType').textContent = 'Fixed';
                }
                document.getElementById('discountRow').style.display = '';
                document.getElementById('discountDisplay').textContent = '- ' + formatPrice(discountAmount);
            } else {
                document.getElementById('discountRow').style.display = 'none';
            }

            // Calculate final totals
            const totalNet = subtotalNet - discountAmount;
            const totalVat = totalNet * 0.19;
            const totalGross = totalNet + totalVat;

            document.getElementById('totalNet').textContent = formatPrice(totalNet);
            document.getElementById('totalVat').textContent = formatPrice(totalVat);
            document.getElementById('totalGross').textContent = formatPrice(totalGross);
        }

        function formatPrice(price) {
            return price.toFixed(2).replace('.', ',') + ' ‚Ç¨';
        }

        function formatPriceForJSON(price) {
            return price.toFixed(2).replace('.', ',');
        }

        // Image management
        let imageCounter = 0;

        function addImageField() {
            imageCounter++;
            const container = document.getElementById('imagesContainer');
            
            const imageItem = document.createElement('div');
            imageItem.className = 'image-item';
            imageItem.id = `image-item-${imageCounter}`;
            imageItem.innerHTML = `
                <div class="image-item-header">
                    <span class="image-item-title">Image ${imageCounter}</span>
                    <button type="button" class="remove-image-btn" onclick="removeImageField(${imageCounter})">
                        üóëÔ∏è Remove
                    </button>
                </div>
                
                <div class="form-group">
                    <label>Image Title</label>
                    <input type="text" 
                           class="image-title-input" 
                           data-image="${imageCounter}"
                           placeholder="e.g. Perspektive 1 - Hauptansicht">
                </div>
                
                <div class="form-group">
                    <label>Image Description</label>
                    <textarea class="image-description-input" 
                              data-image="${imageCounter}"
                              placeholder="e.g. Ansicht der Immobilie von S√ºden mit optimaler Beleuchtung"
                              rows="3"></textarea>
                </div>
                
                <div class="form-group">
                    <label>Upload Image *</label>
                    <div class="image-upload-area" onclick="document.getElementById('imageFile-${imageCounter}').click()">
                        <div class="image-upload-icon">üì∑</div>
                        <div class="image-upload-text">Click to upload image</div>
                        <div class="image-upload-text" style="font-size: 12px; margin-top: 4px;">PNG, JPG, JPEG (Max 5MB)</div>
                        <img class="image-preview" id="imagePreview-${imageCounter}" />
                    </div>
                    <input type="file" 
                           id="imageFile-${imageCounter}"
                           class="image-file-input"
                           data-image="${imageCounter}"
                           accept="image/png,image/jpeg,image/jpg"
                           style="display: none;"
                           onchange="handleImageUpload(${imageCounter})">
                    <span class="helper-text">Optional: This image will be included in the proposal document</span>
                </div>
            `;
            
            container.appendChild(imageItem);
        }

        function removeImageField(id) {
            const item = document.getElementById(`image-item-${id}`);
            if (item) {
                item.remove();
            }
        }

        function handleImageUpload(id) {
            const fileInput = document.getElementById(`imageFile-${id}`);
            const preview = document.getElementById(`imagePreview-${id}`);
            const uploadArea = fileInput.closest('.image-upload-area');
            
            if (fileInput.files && fileInput.files[0]) {
                const file = fileInput.files[0];
                
                // Check file size (5MB max)
                if (file.size > 5 * 1024 * 1024) {
                    alert('File size must be less than 5MB');
                    fileInput.value = '';
                    return;
                }
                
                // Preview image
                const reader = new FileReader();
                reader.onload = function(e) {
                    if (preview) {
                        preview.src = e.target.result;
                        preview.classList.add('show');
                    }
                    if (uploadArea) {
                        uploadArea.classList.add('has-image');
                        const uploadText = uploadArea.querySelector('.image-upload-text');
                        if (uploadText) {
                            uploadText.textContent = `‚úÖ ${file.name}`;
                        }
                    }
                };
                reader.readAsDataURL(file);
            }
        }

        // ========== BULLET POINT MANAGEMENT ==========
        
        // Store for bullet points data structure
        let serviceBullets = {};

        // Default service descriptions
        const serviceDefaults = {
            'exterior-ground': [
                'Fotorealistische 3D-Visualisierung aus Bodenperspektive',
                'Hochaufl√∂sende Darstellung (min. 3000px)',
                'Professionelle Lichtsetzung und Materialisierung',
                'Umgebungsgestaltung mit Vegetation und Kontext'
            ],
            'exterior-bird': [
                'Fotorealistische Vogelperspektive',
                'Ideal f√ºr Gesamt√ºbersicht des Projekts',
                'Nur in Kombination mit Bodenperspektiven'
            ],
            '3d-floorplan': [
                'Fotorealistischer 3D-Grundriss',
                'M√∂blierte Darstellung',
                'Hochaufl√∂sende Qualit√§t'
            ],
            '3d-complete-floor': [
                'Komplette 3D-Ansicht eines Geschosses',
                'Alle Wohnungen in einem Geschoss',
                'M√∂blierte Darstellung'
            ],
            '2d-floorplan': [
                'Professioneller 2D-Grundriss',
                'Bema√üung und Fl√§chenangaben',
                'Druckfertige Qualit√§t'
            ],
            'home-staging': [
                'Digitale M√∂blierung leerer R√§ume',
                'Fotorealistische Integration',
                'Verschiedene Einrichtungsstile'
            ],
            'renovation': [
                'Digitale Aufbereitung alter R√§ume',
                'Visualisierung von Renovierungspotential',
                'Fotorealistische Darstellung'
            ],
            '360-interior': [
                'Interaktive 360¬∞ Innenraumtour',
                'Navigation durch alle R√§ume',
                'Einbettbar auf Website'
            ],
            '360-exterior': [
                {
                    text: '360¬∞ Au√üenansicht Video',
                    children: ['Nur mit min. 2x 3D-Au√üenvisualisierung', 'Preis auf Anfrage']
                }
            ],
            'slideshow': [
                'Professionelles Slideshow-Video',
                'Musik und √úberg√§nge',
                'Ideal f√ºr Social Media'
            ],
            'site-plan': [
                '3D-Darstellung der Lage',
                'Umgebungskontext',
                'Verkehrsanbindung'
            ],
            'social-media': [
                'Optimierte Bilder f√ºr Social Media',
                'Verschiedene Formate',
                'Stories und Posts'
            ],
            'interior': [
                'Fotorealistische Innenraumvisualisierung',
                'Hochaufl√∂sende Darstellung',
                'Professionelle Lichtsetzung',
                'Verschiedene Perspektiven m√∂glich'
            ],
            'terrace': [
                'Fotorealistische Terrassenvisualisierung',
                'Mit M√∂blierung und Bepflanzung',
                'Preis auf Anfrage'
            ]
        };

        // Initialize bullet UI for all services on page load
        function initializeBulletUI() {
            Object.keys(serviceDefaults).forEach(serviceId => {
                const textarea = document.querySelector(`textarea[data-service="${serviceId}"]`);
                if (!textarea) return;
                
                const formGroup = textarea.closest('.form-group');
                if (!formGroup) return;
                
                // Replace textarea with bullet UI
                const defaults = serviceDefaults[serviceId];
                const defaultsHTML = renderDefaultBullets(defaults);
                
                const bulletUI = document.createElement('div');
                bulletUI.innerHTML = `
                    <label>Description Details (Optional)</label>
                    ${defaultsHTML}
                    <div class="bullets-container" id="bullets-${serviceId}">
                        <ul class="bullet-list" data-service="${serviceId}"></ul>
                    </div>
                    <button type="button" class="add-bullet-btn" onclick="addBulletPoint('${serviceId}')">+ Add Custom Bullet Point</button>
                    <span class="helper-text">Add custom description points - they will appear below defaults</span>
                `;
                
                // Replace the form group content
                formGroup.innerHTML = '';
                formGroup.appendChild(bulletUI);
            });
        }

        // Render default bullets with sub-bullets
        function renderDefaultBullets(defaults) {
            if (!defaults || defaults.length === 0) return '';
            
            let html = '<div class="default-bullets"><div class="default-bullets-title">Default Description:</div><ul>';
            
            defaults.forEach(item => {
                if (typeof item === 'object' && item.text) {
                    html += `<li>${item.text}`;
                    if (item.children && item.children.length > 0) {
                        html += '<ul style="list-style-type: circle; margin-left: 20px;">';
                        item.children.forEach(child => {
                            html += `<li>${child}</li>`;
                        });
                        html += '</ul>';
                    }
                    html += '</li>';
                } else {
                    html += `<li>${item}</li>`;
                }
            });
            
            html += '</ul></div>';
            return html;
        }

        // Add a new bullet point to a service
        function addBulletPoint(serviceId) {
            if (!serviceBullets[serviceId]) {
                serviceBullets[serviceId] = [];
            }

            const bulletId = Date.now() + Math.random();
            serviceBullets[serviceId].push({
                id: bulletId,
                text: '',
                children: []
            });

            renderBullets(serviceId);
            
            // Focus on the new input
            setTimeout(() => {
                const input = document.querySelector(`input[data-bullet-id="${bulletId}"]`);
                if (input) input.focus();
            }, 50);
            
            saveFormData();
        }

        // Add a sub-bullet to a parent bullet
        function addSubBullet(serviceId, parentId) {
            if (!serviceBullets[serviceId]) return;

            const parentBullet = serviceBullets[serviceId].find(b => b.id === parentId);
            if (!parentBullet) return;

            const subBulletId = Date.now() + Math.random();
            parentBullet.children.push({
                id: subBulletId,
                text: ''
            });

            renderBullets(serviceId);
            
            // Focus on the new input
            setTimeout(() => {
                const input = document.querySelector(`input[data-bullet-id="${subBulletId}"]`);
                if (input) input.focus();
            }, 50);
            
            saveFormData();
        }

        // Delete a bullet point
        function deleteBullet(serviceId, bulletId, isSubBullet = false, parentId = null) {
            if (!serviceBullets[serviceId]) return;

            if (isSubBullet && parentId) {
                const parentBullet = serviceBullets[serviceId].find(b => b.id === parentId);
                if (parentBullet) {
                    parentBullet.children = parentBullet.children.filter(sub => sub.id !== bulletId);
                }
            } else {
                serviceBullets[serviceId] = serviceBullets[serviceId].filter(b => b.id !== bulletId);
            }

            renderBullets(serviceId);
            saveFormData();
        }

        // Update bullet text
        function updateBulletText(serviceId, bulletId, text, isSubBullet = false, parentId = null) {
            if (!serviceBullets[serviceId]) return;

            if (isSubBullet && parentId) {
                const parentBullet = serviceBullets[serviceId].find(b => b.id === parentId);
                if (parentBullet) {
                    const subBullet = parentBullet.children.find(sub => sub.id === bulletId);
                    if (subBullet) {
                        subBullet.text = text;
                    }
                }
            } else {
                const bullet = serviceBullets[serviceId].find(b => b.id === bulletId);
                if (bullet) {
                    bullet.text = text;
                }
            }
            
            saveFormData();
        }

        // Render bullets for a service
        function renderBullets(serviceId) {
            const container = document.querySelector(`ul[data-service="${serviceId}"]`);
            if (!container) return;

            const bullets = serviceBullets[serviceId] || [];
            container.innerHTML = '';

            bullets.forEach(bullet => {
                // Main bullet
                const li = document.createElement('li');
                li.className = 'bullet-item';
                li.innerHTML = `
                    <span class="bullet-marker">\u2022</span>
                    <input type="text" 
                           class="bullet-input" 
                           value="${bullet.text || ''}" 
                           placeholder="Enter bullet point text..."
                           data-bullet-id="${bullet.id}"
                           onchange="updateBulletText('${serviceId}', ${bullet.id}, this.value)">
                    <div class="bullet-controls">
                        <button type="button" 
                                class="bullet-control-btn add-sub" 
                                onclick="addSubBullet('${serviceId}', ${bullet.id})"
                                title="Add sub-bullet">+ Sub</button>
                        <button type="button" 
                                class="bullet-control-btn delete" 
                                onclick="deleteBullet('${serviceId}', ${bullet.id})"
                                title="Delete">\u2715</button>
                    </div>
                `;
                container.appendChild(li);

                // Sub-bullets
                if (bullet.children && bullet.children.length > 0) {
                    bullet.children.forEach(subBullet => {
                        const subLi = document.createElement('li');
                        subLi.className = 'bullet-item sub-bullet';
                        subLi.innerHTML = `
                            <span class="bullet-marker">\u25E6</span>
                            <input type="text" 
                                   class="bullet-input" 
                                   value="${subBullet.text || ''}" 
                                   placeholder="Enter sub-bullet text..."
                                   data-bullet-id="${subBullet.id}"
                                   onchange="updateBulletText('${serviceId}', ${subBullet.id}, this.value, true, ${bullet.id})">
                            <div class="bullet-controls">
                                <button type="button" 
                                        class="bullet-control-btn delete" 
                                        onclick="deleteBullet('${serviceId}', ${subBullet.id}, true, ${bullet.id})"
                                        title="Delete">\u2715</button>
                            </div>
                        `;
                        container.appendChild(subLi);
                    });
                }
            });
        }

        // Convert bullets to the format expected by collectFormData
        function bulletsToDescriptionArray(serviceId) {
            // Get textarea content for this service
            const textarea = document.querySelector(`.custom-description-textarea[data-service="${serviceId}"]`);
            if (!textarea || !textarea.value.trim()) {
                return null;
            }

            const lines = textarea.value.split('\n').filter(line => line.trim());
            if (lines.length === 0) return null;

            const result = [];
            let currentMainBullet = null;
            let currentSubBullets = [];

            lines.forEach(line => {
                const trimmedLine = line.trim();
                
                if (trimmedLine.startsWith('--')) {
                    // Sub-sub-bullet (add to current sub-bullet's children if exists)
                    const text = trimmedLine.substring(2).trim();
                    if (text && currentSubBullets.length > 0) {
                        // Get the last sub-bullet and add this as its child
                        const lastSubIndex = currentSubBullets.length - 1;
                        if (typeof currentSubBullets[lastSubIndex] === 'string') {
                            // Convert last sub-bullet to object with children
                            currentSubBullets[lastSubIndex] = {
                                text: currentSubBullets[lastSubIndex],
                                children: [text]
                            };
                        } else if (currentSubBullets[lastSubIndex].children) {
                            currentSubBullets[lastSubIndex].children.push(text);
                        }
                    }
                } else if (trimmedLine.startsWith('-')) {
                    // Sub-bullet
                    const text = trimmedLine.substring(1).trim();
                    if (text) {
                        currentSubBullets.push(text);
                    }
                } else {
                    // Main bullet - save previous main bullet if exists
                    if (currentMainBullet !== null) {
                        if (currentSubBullets.length > 0) {
                            result.push({
                                text: currentMainBullet,
                                children: currentSubBullets
                            });
                        } else {
                            result.push(currentMainBullet);
                        }
                    }
                    // Start new main bullet
                    currentMainBullet = trimmedLine;
                    currentSubBullets = [];
                }
            });

            // Don't forget the last bullet
            if (currentMainBullet !== null) {
                if (currentSubBullets.length > 0) {
                    result.push({
                        text: currentMainBullet,
                        children: currentSubBullets
                    });
                } else {
                    result.push(currentMainBullet);
                }
            }

            return result.length > 0 ? result : null;
        }

        // ========== END BULLET POINT MANAGEMENT ==========

        function collectImageData(includeImageData = true) {
            const images = [];
            const imageItems = document.querySelectorAll('.image-item');
            
            imageItems.forEach(item => {
                const id = item.id.split('-')[2];
                const titleInput = item.querySelector('.image-title-input');
                const descriptionInput = item.querySelector('.image-description-input');
                const fileInput = item.querySelector('.image-file-input');
                const preview = item.querySelector('.image-preview');
                
                // Include images even if title/description are optional
                if (fileInput && fileInput.files[0]) {
                    const imageObj = {
                        title: titleInput ? titleInput.value.trim() : '',
                        description: descriptionInput ? descriptionInput.value.trim() : '',
                        fileName: fileInput.files[0].name,
                        fileSize: fileInput.files[0].size,
                        fileType: fileInput.files[0].type
                    };
                    
                    // Only include base64 data when sending to server (not for localStorage)
                    if (includeImageData && preview && preview.src) {
                        imageObj.imageData = preview.src;
                    }
                    
                    images.push(imageObj);
                }
            });
            
            return images;
        }

        function generateJSON() {
            const data = collectFormData();
            const jsonString = JSON.stringify(data, null, 2);
            
            document.getElementById('jsonOutput').textContent = jsonString;
            document.getElementById('jsonOutput').classList.add('show');
            document.getElementById('copyBtn').style.display = 'block';
            
            // Scroll to JSON
            document.getElementById('jsonOutput').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        function collectFormData() {
            // Helper function to safely get element value
            const getElementValue = (id, defaultValue = '') => {
                const element = document.getElementById(id);
                return element ? element.value : defaultValue;
            };
            
            // Calculate totals
            let totalNet = 0;
            const services = [];

            document.querySelectorAll('.service-item.active').forEach(item => {
                const checkbox = item.querySelector('input[type="checkbox"]');
                const serviceName = checkbox.nextElementSibling.textContent;
                const quantityInput = item.querySelector('.quantity-input');
                const quantity = parseInt(quantityInput?.value) || 0;
                const service = quantityInput?.dataset.service;
                
                // Get custom description from bullet point system
                const descriptionArray = bulletsToDescriptionArray(service);
                
                if (service && quantity > 0) {
                    const priceFunc = pricing[service];
                    let unitPrice, serviceTotal;
                    
                    // Check if custom price is provided
                    const customPriceInput = item.querySelector('.custom-price-input');
                    const customPrice = customPriceInput ? parseFloat(customPriceInput.value) : null;
                    
                    // Use custom price if provided, otherwise calculate from pricing function
                    if (customPrice && customPrice > 0) {
                        unitPrice = customPrice;
                        serviceTotal = unitPrice * quantity;
                    } else {
                        // Get additional parameters based on service type
                        if (service === 'exterior-ground') {
                            const buildingType = item.querySelector('.building-type-input')?.value;
                            unitPrice = priceFunc(quantity, buildingType);
                            serviceTotal = unitPrice * quantity;
                        } else if (service === '360-interior') {
                            const apartmentSize = item.querySelector('.apartment-size-input')?.value;
                            unitPrice = priceFunc(apartmentSize);
                            serviceTotal = unitPrice * quantity;
                        } else if (service === '360-exterior') {
                            const buildingType = item.querySelector('.building-type-input')?.value;
                            unitPrice = priceFunc(buildingType);
                            serviceTotal = unitPrice * quantity;
                        } else if (service === '3d-floorplan' || service === '2d-floorplan') {
                            const projectType = item.querySelector('.project-type-input')?.value;
                            const areaSize = item.querySelector('.area-size-input')?.value;
                            unitPrice = priceFunc(projectType, areaSize);
                            serviceTotal = unitPrice * quantity;
                        } else if (service === 'interior') {
                            unitPrice = priceFunc(quantity);
                            serviceTotal = unitPrice * quantity;
                        } else {
                            unitPrice = priceFunc();
                            serviceTotal = unitPrice * quantity;
                        }
                    }
                    
                    totalNet += serviceTotal;
                    
                    const serviceData = {
                        name: serviceName,
                        quantity: quantity,
                        unitPrice: formatPriceForJSON(unitPrice),
                        totalPrice: formatPriceForJSON(serviceTotal)
                    };
                    
                    // Add custom price if provided
                    if (customPrice && customPrice > 0) {
                        serviceData.customPrice = customPrice;
                    }
                    
                    // Add additional parameters to serviceData
                    if (service === 'exterior-ground' || service === '360-exterior') {
                        const buildingType = item.querySelector('.building-type-input')?.value;
                        if (buildingType) serviceData.buildingType = buildingType;
                    } else if (service === '360-interior') {
                        const apartmentSize = item.querySelector('.apartment-size-input')?.value;
                        if (apartmentSize) serviceData.apartmentSize = apartmentSize;
                    } else if (service === '3d-floorplan' || service === '2d-floorplan') {
                        const projectType = item.querySelector('.project-type-input')?.value;
                        const areaSize = item.querySelector('.area-size-input')?.value;
                        if (projectType) serviceData.projectType = projectType;
                        if (areaSize) serviceData.areaSize = areaSize;
                    }
                    
                    // Add custom description if provided
                    if (descriptionArray && descriptionArray.length > 0) {
                        serviceData.customDescription = descriptionArray;
                    }
                    
                    services.push(serviceData);
                }
            });

            // Calculate discount
            let discountAmount = 0;
            const discountType = getElementValue('discountType');
            const discountValue = parseFloat(getElementValue('discountAmount')) || 0;
            const discountDescription = getElementValue('discountDescription', 'Rabatt');
            
            if (discountType && discountValue > 0) {
                if (discountType === 'percentage') {
                    discountAmount = totalNet * (discountValue / 100);
                } else if (discountType === 'fixed') {
                    discountAmount = discountValue;
                }
            }

            // Calculate final totals with discount
            const finalTotalNet = totalNet - discountAmount;
            const totalVat = finalTotalNet * 0.19;
            const totalGross = finalTotalNet + totalVat;

            const today = new Date();
            const dateStr = today.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit', year: 'numeric' });
            
            const result = {
                clientInfo: {
                    clientNumber: getElementValue('clientNumber'),
                    companyName: getElementValue('companyName', 'Company'),
                    street: getElementValue('street', 'Street'),
                    postalCode: getElementValue('postalCode', 'ZIP'),
                    city: getElementValue('city', 'City'),
                    country: getElementValue('country', 'Deutschland')
                },
                projectInfo: {
                    projectNumber: getElementValue('projectNumber'),
                    projectName: getElementValue('projectName'),
                    unitCount: getElementValue('unitCount'),
                    deliveryDays: getElementValue('deliveryDays', 'XXX'),
                    offerValidUntil: getElementValue('offerValidUntil', 'XX.XX.25'),
                    sharepointUrl: getElementValue('sharepointUrl'),
                    date: dateStr,
                    MM: String(today.getMonth() + 1).padStart(2, '0'),
                    DD: String(today.getDate()).padStart(2, '0')
                },
                services: services,
                images: collectImageData(true), // Include image data by default
                pricing: {
                    subtotalNet: formatPriceForJSON(totalNet),
                    totalNetPrice: formatPriceForJSON(finalTotalNet),
                    totalVat: formatPriceForJSON(totalVat),
                    totalGrossPrice: formatPriceForJSON(totalGross)
                },
                signature: {
                    signatureName: 'Christopher Helm'
                }
            };
            
            // Add discount info if applicable
            if (discountType && discountValue > 0) {
                result.pricing.discount = {
                    type: discountType,
                    value: discountValue,
                    amount: formatPriceForJSON(discountAmount),
                    description: discountDescription
                };
            }
            
            return result;
        }

        function copyJSON() {
            const jsonText = document.getElementById('jsonOutput').textContent;
            navigator.clipboard.writeText(jsonText).then(() => {
                const btn = document.getElementById('copyBtn');
                const originalText = btn.textContent;
                btn.textContent = '‚úÖ Copied!';
                setTimeout(() => {
                    btn.textContent = originalText;
                }, 2000);
            });
        }

        function resetForm() {
            if (confirm('Are you sure you want to reset the form? This will clear all saved data.')) {
                document.getElementById('proposalForm').reset();
                document.querySelectorAll('.service-item').forEach(item => {
                    item.classList.remove('active');
                });
                document.getElementById('jsonOutput').classList.remove('show');
                document.getElementById('copyBtn').style.display = 'none';
                // Clear images
                document.getElementById('imagesContainer').innerHTML = '';
                imageCounter = 0;
                updateCalculations();
                clearSavedData(); // Clear saved data
            }
        }

        // Preview proposal function
        function previewProposal() {
            try {
                console.log('Preview button clicked');
                
                // Validate required fields
                const companyName = document.getElementById('companyName').value;
                const street = document.getElementById('street').value;
                const postalCode = document.getElementById('postalCode').value;
                const city = document.getElementById('city').value;
                const country = document.getElementById('country').value;

                console.log('Client info:', { companyName, street, postalCode, city, country });

                if (!companyName || !street || !postalCode || !city || !country) {
                    alert('Please fill in all required client information fields.');
                    return;
                }

                // Collect form data
                console.log('Collecting form data...');
                const data = collectFormData();
                console.log('Form data collected:', data);

                // Check if at least one service is selected
                if (data.services.length === 0) {
                    alert('Please select at least one service.');
                    return;
                }

                // Store data in localStorage for preview
                console.log('Storing data in localStorage...');
                try {
                    localStorage.setItem('proposalPreviewData', JSON.stringify(data));
                    console.log('Data stored successfully');
                } catch (storageError) {
                    if (storageError.name === 'QuotaExceededError') {
                        console.warn('‚ö†Ô∏è Storage quota exceeded. Preview will work but data may not persist.');
                        // Try storing without some non-critical data or use sessionStorage as fallback
                        try {
                            sessionStorage.setItem('proposalPreviewData', JSON.stringify(data));
                            console.log('Data stored in sessionStorage as fallback');
                        } catch (sessionError) {
                            console.error('Failed to store in sessionStorage:', sessionError);
                            alert('Warning: Unable to store all data due to size. Preview may be incomplete.');
                        }
                    } else {
                        throw storageError;
                    }
                }

                // Open preview page
                console.log('Opening preview page...');
                window.open('preview.html', '_blank');
            } catch (error) {
                console.error('Error in previewProposal:', error);
                alert('An error occurred while preparing the preview. Check the console for details.');
            }
        }

        // Form submission - now deprecated in favor of preview
        document.getElementById('proposalForm').addEventListener('submit', function(e) {
            e.preventDefault();
            alert('Please use the "Preview Proposal" button to view and generate your proposal.');
        });

        // ========== SUPABASE INTEGRATION ==========
        let supabaseClient = null;
        
        async function initializeSupabase() {
            try {
                // DISABLED FOR TESTING - Database connection temporarily disabled
                console.log('Database connection disabled for testing - using manual entry only');
                return;
                
                // Dynamically import Supabase client
                const { createClient } = await import('https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm');
                
                // Get credentials from environment - use relative URL to work on any server
                const apiUrl = window.API_CONFIG?.baseUrl || window.location.origin;
                const response = await fetch(`${apiUrl}/api/config`);
                const config = await response.json();
                
                supabaseClient = createClient(config.supabaseUrl, config.supabaseKey);
                
                // Load companies and clients
                await loadCompaniesAndClients();
            } catch (error) {
                console.error('Failed to initialize Supabase:', error);
                console.log('Continuing in manual entry mode');
            }
        }
        
        async function loadCompaniesAndClients() {
            if (!supabaseClient) return;
            
            try {
                // Fetch clients with company information
                const { data: clients, error } = await supabaseClient
                    .from('v_proposals_full')
                    .select('client_id, contact_name, company_name, company_id')
                    .order('company_name');
                
                if (error) throw error;
                
                const clientSelect = document.getElementById('clientId');
                
                // Clear existing options except first two
                while (clientSelect.options.length > 2) {
                    clientSelect.remove(2);
                }
                
                // Add clients as options
                const uniqueClients = {};
                clients?.forEach(client => {
                    const key = client.company_id || client.company_name;
                    if (!uniqueClients[key]) {
                        uniqueClients[key] = {
                            id: client.client_id || client.company_id,
                            name: client.company_name || 'Unknown',
                            companyId: client.company_id
                        };
                    }
                });
                
                Object.values(uniqueClients).forEach(client => {
                    const option = document.createElement('option');
                    option.value = client.id;
                    option.textContent = client.name;
                    option.dataset.companyId = client.companyId;
                    option.dataset.companyName = client.name;
                    clientSelect.appendChild(option);
                });
                
            } catch (error) {
                console.error('Error loading clients:', error);
            }
        }
        
        // Handle client selection
        document.getElementById('clientId')?.addEventListener('change', async function(e) {
            const selectedOption = e.target.options[e.target.selectedIndex];
            const clientId = e.target.value;
            const companyNameInput = document.getElementById('companyName');
            const companyNameGroup = document.getElementById('companyNameGroup');
            
            if (clientId === 'manual' || clientId === '') {
                // Manual entry mode - enable company name input and clear all fields
                companyNameInput.readOnly = false;
                companyNameInput.style.background = '';
                companyNameInput.style.cursor = '';
                companyNameInput.value = '';
                document.getElementById('street').value = '';
                document.getElementById('postalCode').value = '';
                document.getElementById('city').value = '';
                document.getElementById('country').value = '';
                companyNameGroup.style.display = 'block';
                return;
            }
            
            if (clientId) {
                // Database selection mode - populate from database
                const companyName = selectedOption.dataset.companyName;
                companyNameInput.value = companyName || '';
                companyNameInput.readOnly = true;
                companyNameInput.style.background = '#f5f7fa';
                companyNameInput.style.cursor = 'not-allowed';
                companyNameGroup.style.display = 'block';
                
                // Load company details
                if (supabaseClient && selectedOption.dataset.companyId) {
                    try {
                        const { data, error } = await supabaseClient
                            .from('companies')
                            .select('*')
                            .eq('id', selectedOption.dataset.companyId)
                            .single();
                        
                        if (data) {
                            document.getElementById('street').value = data.street || '';
                            document.getElementById('postalCode').value = data.postal_code || '';
                            document.getElementById('city').value = data.city || '';
                            document.getElementById('country').value = data.country || 'Deutschland';
                        }
                    } catch (error) {
                        console.error('Error loading company details:', error);
                    }
                }
            }
        });
        
        // Initialize project type dropdown
        function initializeProjectTypes() {
            const projectTypeSelect = document.getElementById('projectType');
            CONFIG.projectTypes.forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type;
                projectTypeSelect.appendChild(option);
            });
            
            // Handle custom project type
            projectTypeSelect.addEventListener('change', function(e) {
                const customGroup = document.getElementById('customProjectTypeGroup');
                if (e.target.value === 'Custom') {
                    customGroup.style.display = 'block';
                } else {
                    customGroup.style.display = 'none';
                }
            });
        }
        
        // Calculate delivery time based on selected services
        function calculateDeliveryTime() {
            let totalMinDays = 0;
            let totalMaxDays = 0;
            
            // Get all checked services
            const checkedServices = document.querySelectorAll('.service-item input[type=\"checkbox\"]:checked');
            
            checkedServices.forEach(checkbox => {
                const serviceId = checkbox.id.replace('check-', '');
                const quantityInput = document.querySelector(`input.quantity-input[data-service=\"${serviceId}\"]`);
                const quantity = parseInt(quantityInput?.value || 0);
                
                if (quantity > 0 && CONFIG.deliveryTimeRules[serviceId]) {
                    const rule = CONFIG.deliveryTimeRules[serviceId];
                    const serviceTime = rule.baseTime + (rule.additionalPerUnit * Math.max(0, quantity - 1));
                    totalMinDays = Math.max(totalMinDays, serviceTime);
                    totalMaxDays = Math.max(totalMaxDays, serviceTime + 3); // Add 3 days buffer for max
                }
            });
            
            // Set minimum delivery time
            if (totalMinDays === 0) {
                totalMinDays = 7;
                totalMaxDays = 14;
            }
            
            document.getElementById('deliveryDaysMin').value = totalMinDays;
            document.getElementById('deliveryDaysMax').value = totalMaxDays;
            document.getElementById('deliveryTime').value = `${totalMinDays} - ${totalMaxDays} Werktage`;
        }
        
        // Update calculations to include delivery time
        const originalUpdateCalculations = updateCalculations;
        updateCalculations = function() {
            originalUpdateCalculations();
            calculateDeliveryTime();
        };

        // Set default date (1 week from now)
        const oneWeekLater = new Date();
        oneWeekLater.setDate(oneWeekLater.getDate() + CONFIG.offerValidityDays);
        document.getElementById('offerValidUntil').valueAsDate = oneWeekLater;

        // Handle client number lookup via button click
        document.getElementById('fetchClientBtn').addEventListener('click', async function(e) {
            const clientNumberInput = document.getElementById('clientNumber');
            const clientNumber = clientNumberInput.value.trim();
            const button = e.target;
            
            // Remove any existing indicators
            const parentDiv = clientNumberInput.parentElement.parentElement;
            const existingIndicators = parentDiv.querySelectorAll('.lookup-indicator');
            existingIndicators.forEach(ind => ind.remove());
            
            if (!clientNumber) {
                const indicator = document.createElement('span');
                indicator.className = 'lookup-indicator helper-text';
                indicator.style.color = 'red';
                indicator.textContent = '‚ö† Please enter a client number';
                parentDiv.appendChild(indicator);
                setTimeout(() => indicator.remove(), 3000);
                return;
            }
            
            // Validate that client number is exactly 5 digits
            if (!/^\d{5}$/.test(clientNumber)) {
                const indicator = document.createElement('span');
                indicator.className = 'lookup-indicator helper-text';
                indicator.style.color = 'red';
                indicator.textContent = '‚ö† Client number must be 5 digits';
                parentDiv.appendChild(indicator);
                setTimeout(() => indicator.remove(), 3000);
                return;
            }
            
            // Show loading state
            button.disabled = true;
            button.style.opacity = '0.6';
            button.textContent = '‚è≥';
            
            console.log('Looking up client number:', clientNumber);
            
            try {
                // Fetch client details from server - use relative URL to work on any server
                const apiUrl = window.API_CONFIG?.API_URL || window.location.origin;
                const response = await fetch(`${apiUrl}/api/client-lookup/${encodeURIComponent(clientNumber)}`);
                
                if (response.ok) {
                    const clientData = await response.json();
                    
                    if (clientData && clientData.success && clientData.data) {
                        const client = clientData.data;
                        console.log('Client data found:', client);
                        
                        // Auto-fill company name only (addresses will be entered manually)
                        document.getElementById('companyName').value = client.company_name || '';
                        
                        // Show success indicator with company name
                        const indicator = document.createElement('span');
                        indicator.className = 'lookup-indicator helper-text';
                        indicator.style.color = 'green';
                        indicator.textContent = '‚úì ' + (client.company_name || 'Client found');
                        parentDiv.appendChild(indicator);
                        setTimeout(() => indicator.remove(), 3000);
                        
                        // Visual feedback on button
                        button.style.background = '#28a745';
                        setTimeout(() => {
                            button.style.background = '#1a2a4a';
                        }, 1000);
                    } else {
                        console.log('Client not found');
                        // Show not found indicator
                        const indicator = document.createElement('span');
                        indicator.className = 'lookup-indicator helper-text';
                        indicator.style.color = 'orange';
                        indicator.textContent = '‚ö† Client not found in database';
                        parentDiv.appendChild(indicator);
                        setTimeout(() => indicator.remove(), 3000);
                        
                        // Visual feedback on button
                        button.style.background = '#dc3545';
                        setTimeout(() => {
                            button.style.background = '#1a2a4a';
                        }, 1000);
                    }
                } else {
                    console.error('Error fetching client data:', response.statusText);
                    const indicator = document.createElement('span');
                    indicator.className = 'lookup-indicator helper-text';
                    indicator.style.color = 'red';
                    indicator.textContent = '‚ö† Error connecting to database';
                    parentDiv.appendChild(indicator);
                    setTimeout(() => indicator.remove(), 3000);
                }
            } catch (error) {
                console.error('Error looking up client:', error);
                const indicator = document.createElement('span');
                indicator.className = 'lookup-indicator helper-text';
                indicator.style.color = 'red';
                indicator.textContent = '‚ö† Connection error';
                parentDiv.appendChild(indicator);
                setTimeout(() => indicator.remove(), 3000);
            } finally {
                // Reset button state
                button.disabled = false;
                button.style.opacity = '1';
                button.textContent = '‚úì';
            }
        });

        // Handle discount type change
        document.getElementById('discountType').addEventListener('change', function(e) {
            const value = e.target.value;
            const amountGroup = document.getElementById('discountAmountGroup');
            const descGroup = document.getElementById('discountDescGroup');
            const helper = document.getElementById('discountHelper');
            
            if (value) {
                amountGroup.style.display = 'block';
                descGroup.style.display = 'block';
                if (value === 'percentage') {
                    helper.textContent = 'Enter percentage (e.g., 10 for 10%)';
                } else {
                    helper.textContent = 'Enter amount in EUR';
                }
            } else {
                amountGroup.style.display = 'none';
                descGroup.style.display = 'none';
            }
            updateCalculations();
        });

        // Handle discount amount/description change
        document.getElementById('discountAmount').addEventListener('input', updateCalculations);
        document.getElementById('discountDescription').addEventListener('input', saveFormData);

        // Initialize on page load
        window.addEventListener('DOMContentLoaded', async function() {
            initializeProjectTypes(); // Initialize project types dropdown
            await initializeSupabase(); // Initialize Supabase connection
            // initializeBulletUI(); // DISABLED - Now using textarea format for bullets
            loadSavedData(); // Load saved data
            startAutoSave(); // Start auto-save
            updateCalculations();
            
            // Set manual entry as default mode
            document.getElementById('clientId').value = 'manual';
            document.getElementById('companyName').readOnly = false;
            document.getElementById('companyName').style.background = '';
            document.getElementById('companyName').style.cursor = '';
        });

        // Save before leaving page
        window.addEventListener('beforeunload', function() {
            saveFormData();
        });
    </script>
</body>
</html>
