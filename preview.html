    <!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Proposal Preview - ExposeProfi.de</title>
  <script src="/config.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    .preview-toolbar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: linear-gradient(135deg, #1a2a4a 0%, #253550 100%);
      padding: 16px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      z-index: 1000;
    }

    .preview-toolbar h1 {
      color: white;
      font-size: 20px;
      font-weight: 600;
    }

    .preview-toolbar-actions {
      display: flex;
      gap: 12px;
    }

    .toolbar-btn {
      padding: 10px 24px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .btn-back {
      background: rgba(255, 255, 255, 0.2);
      color: white;
    }

    .btn-back:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    .btn-generate {
      background: #10b981;
      color: white;
    }

    .btn-generate:hover {
      background: #059669;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
    }

    .btn-generate:disabled {
      background: #6b7280;
      cursor: not-allowed;
      transform: none;
    }

    /* ========== PAGE STYLE (Word Document Feel) ========== */
    body {
      font-family: "Calibri", "Arial", sans-serif;
      font-size: 11pt;
      line-height: 1.5;
      background: #f9f9f9;
      color: #000;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 80px 20px 40px 20px; /* Top padding for toolbar */
    }

    .page {
      width: 793px;
      min-height: 1122px;
      max-width: 793px;
      padding: 96px;
      margin-bottom: 40px;
      background: white;
      box-shadow: 0 0 8px rgba(0, 0, 0, 0.15);
      border: 1px solid #dcdcdc;
      display: flex;
      flex-direction: column;
      page-break-after: always;
      position: relative;
      box-sizing: border-box;
    }

    .page:last-child {
      margin-bottom: 0;
    }

    .page-content {
      flex: 1;
      padding-bottom: 100px;
      min-height: 930px; /* Ensure minimum content height */
    }

    /* Services table page */
    #servicesTable {
      margin-bottom: 40px;
    }

    /* Ensure pricing summary starts on new page if needed */
    .section-title {
      page-break-after: avoid;
    }

    /* ========== PAGE ONE STYLES ========== */
    .exposeprofi-logo {
      display: flex;
      justify-content: flex-end;
      margin-bottom: 24px;
    }

    .exposeprofi-logo img {
      max-width: 320px;
      height: auto;
    }

    .header-left {
      font-size: 11pt;
      color: #022e64;
      margin-bottom: 8px;
    }

    .recipient-address {
      margin-top: 16px;
      margin-bottom: 24px;
      line-height: 1.4;
      font-size: 11pt;
    }

    .date-offer {
      margin-bottom: 32px;
      text-align: right;
      font-size: 11pt;
    }

    .offer-number-section {
      font-weight: bold;
      font-size: 16pt;
      margin-bottom: 16px;
    }

    .intro-text {
      text-align: justify;
      margin-bottom: 12px;
      font-size: 11pt;
    }

    .benefits-list {
      margin: 28px 0;
      font-size: 12pt;
      line-height: 1.6;
    }

    .benefits-list > div {
      margin-bottom: 8px;
      text-align: justify;
    }

    .benefits-list strong {
      font-weight: bold;
    }

    /* ========== PAGE TWO+ STYLES ========== */
    .header-text {
      margin-bottom: 16px;
      font-size: 10pt;
      line-height: 1.4;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 24px;
      font-size: 9pt;
      page-break-inside: auto;/* ========== PREVIEW TOOLBAR ========== */
    }

    tr {
      page-break-inside: avoid;
      page-break-after: auto;
    }

    thead {
      display: table-header-group;
    }

    tbody {
      display: table-row-group;
    }

    th, td {
      border: 1px solid #333;
      padding: 5px 6px;
      text-align: left;
      vertical-align: top;
      line-height: 1.3;
    }

    th {
      background-color: #f0f0f0;
      font-weight: bold;
      text-align: center;
      font-size: 9pt;
    }

    .col-number {
      width: 8%;
      text-align: center;
    }

    .col-designation {
      width: 28%;
    }

    .col-description {
      width: 54%;
    }

    .col-price {
      width: 10%;
      text-align: center;
    }

    ul {
      margin: 4px 0 4px 14px;
      padding-left: 0;
    }

    li {
      margin-bottom: 2px;
      line-height: 1.3;
    }

    /* Editable fields */
    .editable {
      cursor: text;
      transition: background-color 0.2s;
    }

    .editable:hover {
      background-color: #fffbeb;
    }

    .editable:focus {
      outline: 2px solid #3b82f6;
      outline-offset: -2px;
      background-color: #fef3c7;
    }

    .editable-bullet {
      cursor: text;
      transition: background-color 0.2s;
      padding: 2px 4px;
      border-radius: 2px;
    }

    .editable-bullet:hover {
      background-color: #fffbeb;
    }

    .editable-bullet:focus {
      outline: 2px solid #3b82f6;
      outline-offset: -2px;
      background-color: #fef3c7;
    }

    .edit-hint {
      font-size: 9px;
      color: #6b7280;
      font-style: italic;
      margin-top: 4px;
    }

    /* Sub-bullet points */
    .sub-bullet {
      margin-left: 20px;
      list-style-type: circle;
    }

    /* Third level bullets (sub-sub-bullets) */
    .sub-bullet .sub-bullet {
      margin-left: 20px;
      list-style-type: square;
    }

    /* Fourth level bullets (max depth) */
    .sub-bullet .sub-bullet .sub-bullet {
      margin-left: 20px;
      list-style-type: disc;
      font-size: 9pt;
    }

    .bullet-controls {
      display: inline-flex;
      gap: 4px;
      margin-left: 8px;
      opacity: 0;
      transition: opacity 0.2s;
    }

    .editable-bullet:hover .bullet-controls,
    .bullet-controls:hover {
      opacity: 1;
    }

    .bullet-btn {
      background: #3b82f6;
      color: white;
      border: none;
      padding: 2px 6px;
      font-size: 10px;
      border-radius: 3px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .bullet-btn:hover {
      background: #2563eb;
    }

    .bullet-btn.delete {
      background: #ef4444;
    }

    .bullet-btn.delete:hover {
      background: #dc2626;
    }

    .bullet-btn.add-sub {
      background: #10b981;
    }

    .bullet-btn.add-sub:hover {
      background: #059669;
    }

    .add-bullet-btn {
      background: #10b981;
      color: white;
      border: none;
      padding: 6px 12px;
      font-size: 11px;
      border-radius: 4px;
      cursor: pointer;
      margin-top: 8px;
      display: inline-block;
    }

    .add-bullet-btn:hover {
      background: #059669;
    }

    /* Pricing tiers */
    .pricing-tiers {
      margin-top: 12px;
      padding: 8px;
      background-color: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      font-size: 8.5pt;
    }

    .pricing-tiers-title {
      font-weight: bold;
      margin-bottom: 6px;
      font-size: 9pt;
      color: #495057;
    }

    .pricing-tier-item {
      padding: 2px 0;
      line-height: 1.4;
      color: #212529;
    }

    .pricing-tier-item:hover {
      background-color: #e9ecef;
    }

    /* Editable last page fields */
    .editable-text {
      cursor: text;
      transition: background-color 0.2s;
      padding: 2px 4px;
      border-radius: 2px;
      display: inline-block;
      min-width: 50px;
    }

    .editable-text:hover {
      background-color: #fffbeb;
    }

    .editable-text:focus {
      outline: 2px solid #3b82f6;
      outline-offset: -2px;
      background-color: #fef3c7;
    }

    .section-title {
      font-weight: bold;
      margin-top: 16px;
      margin-bottom: 8px;
      font-size: 11pt;
    }

    .pricing-summary {
      width: 100%;
      border-collapse: collapse;
      margin-top: 16px;
    }

    .summary-row {
      border: 1px solid #333;
    }

    .discount-row {
      background-color: #fff3cd;
    }

    .discount-row .summary-value {
      color: #856404;
    }

    .add-discount-btn {
      background-color: #28a745;
      color: white;
      border: none;
      padding: 8px 16px;
      margin: 10px 0;
      cursor: pointer;
      border-radius: 4px;
      font-size: 14px;
    }

    .add-discount-btn:hover {
      background-color: #218838;
    }

    .remove-discount-btn {
      background-color: #dc3545;
      color: white;
      border: none;
      padding: 4px 12px;
      margin-left: 10px;
      cursor: pointer;
      border-radius: 4px;
      font-size: 12px;
    }

    .remove-discount-btn:hover {
      background-color: #c82333;
    }

    .summary-label {
      padding: 6px 8px;
      width: 70%;
      border: 1px solid #333;
    }

    .summary-value {
      padding: 6px 8px;
      width: 30%;
      text-align: center;
      border: 1px solid #333;
    }

    .footnote {
      font-size: 8.5pt;
      margin-top: 16px;
      line-height: 1.4;
    }

    /* ========== FOOTER ========== */
    .page-footer {
      position: absolute;
      bottom: 48px;
      left: 96px;
      right: 96px;
      padding-top: 8px;
      border-top: none;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      font-size: 7pt;
      line-height: 1.2;
      background: white;
    }

    .footer-column {
      flex: 1;
      margin-right: 12px;
      min-width: 0;
    }

    .footer-column:last-child {
      margin-right: 0;
    }

    .footer-column p {
      margin: 1px 0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      font-size: 7pt;
    }

    .company-name {
      font-weight: bold;
      font-size: 8pt;
      margin-bottom: 3px;
    }

    .reference {
      color: #0066cc;
      text-decoration: none;
    }

    /* Empty state */
    .empty-state {
      text-align: center;
      padding: 40px;
      color: #6b7280;
      font-style: italic;
    }

    /* Perspective images */
    .perspective-image-item {
      margin-bottom: 32px;
      page-break-inside: avoid;
    }

    .perspective-image-title {
      font-weight: bold;
      font-size: 11pt;
      margin-bottom: 8px;
      color: #1a2a4a;
    }

    .perspective-image-description {
      font-size: 10pt;
      margin-bottom: 12px;
      text-align: justify;
      line-height: 1.4;
    }

    .perspective-image-preview {
      width: 100%;
      max-width: 600px;
      height: auto;
      border-radius: 4px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      margin: 0 auto;
      display: block;
    }

    /* ========== PRINT ========== */
    @media print {
      .preview-toolbar {
        display: none;
      }

      body {
        background: white;
        padding: 0;
      }
      
      .page {
        box-shadow: none;
        border: none;
        width: 8.27in;
        height: 11.69in;
        padding: 1in;
        margin: 0;
        page-break-after: always;
        box-sizing: border-box;
      }
      
      .page:last-child {
        page-break-after: avoid;
      }
      
      .page-footer {
        position: absolute;
        bottom: 0.5in;
        left: 1in;
        right: 1in;
      }
      
      table {
        page-break-inside: auto;
      }
      
      tr {
        page-break-inside: avoid;
        page-break-after: auto;
      }
      
      thead {
        display: table-header-group;
      }
    }
    
    @page {
      size: 8.27in 11.69in;
      margin: 0;
    }
  </style>
</head>
<body>
  <!-- Preview Toolbar -->
  <div class="preview-toolbar">
    <h1>üìÑ Proposal Preview</h1>
    <div class="preview-toolbar-actions">
      <button class="toolbar-btn btn-back" onclick="goBack()">‚Üê Back to Form</button>
      <button class="toolbar-btn btn-generate" onclick="generateProposal()" id="generateBtn">
        üìÑ Generate DOCX
      </button>
    </div>
  </div>

  <!-- ========================================
       PAGE 0: COVER / INTRODUCTION
       ======================================== -->
  <div class="page">
    <div class="page-content">
      <!-- Header -->
      <div class="exposeprofi-logo">
        <img src="6363f6e55943431f0f248941_logo exposeprofi blau-p-500.png" alt="ExposeProfi.de">
      </div>
      <div class="header-left">
        ExposeProfi.de | EPCS GmbH | Bruder-Klaus-Stra√üe 3a | 78467 Konstanz
      </div>

      <!-- Recipient Address -->
      <div class="recipient-address">
        <div class="address-block">
          <span class="company-name" id="preview-companyName"></span><br>
          <span id="preview-street"></span><br>
          <span><span id="preview-postalCode"></span> <span id="preview-city"></span></span><br>
          <span id="preview-country"></span>
        </div>
      </div>

      <!-- Date and Offer Number -->
      <div class="date-offer">
        <div id="preview-date"></div>
      </div>

      <!-- Introduction -->
      <div class="offer-number-section">
        Angebot Nr. <span id="preview-offerNumber"></span>
      </div>
      <div class="intro-text">
        Vielen Dank f√ºr Ihre Anfrage und Ihr damit verbundenes Interesse an einer Zusammenarbeit.
      </div>

      <div class="intro-text">
        <strong>Die Vorteile zusammengefasst, die Sie erwarten k√∂nnen:</strong>
      </div>

      <!-- Benefits List -->
      <div class="benefits-list">
        <div><strong>1. Fotorealismus:</strong> Wir erstellen ausschlie√ülich emotionale 3D-Visualisierungen der h√∂chsten Qualit√§tsstufe.</div>
        <div><strong>2. Pers√∂nliche & individuelle Betreuung:</strong> Sie erhalten bei jedem Projekt die Unterst√ºtzung von einem pers√∂nlichen Ansprechpartner, der die Visualisierungen individuell f√ºr Sie erstellt und immer per Telefon oder Email erreichbar ist.</div>
        <div><strong>3. Effiziente Prozesse & schnelle Lieferzeit:</strong> Wie Sie sehen, melden wir uns innerhalb von 24h mit einem Angebot bei Ihnen. Ihr Projekt verl√§uft ab Start ebenso reibungslos und Sie erhalten die Visualisierungen schnellstm√∂glich.</div>
        <div><strong>4. Korrekturschleifen:</strong> Falls Sie √Ñnderungsw√ºnsche haben, bieten wir Ihnen ein eigenes Tool, mit dem Sie direkt in der Visualisierung Kommentare hinterlassen k√∂nnen. Das spart Zeit und Missverst√§ndnisse.</div>
        <div><strong>5. Preiswert:</strong> Aufgrund effizienter Prozesse bieten wir g√ºnstigere Preise bei gleicher Qualit√§t und besserer Betreuung.</div>
      </div>
    </div>

    <!-- Footer -->
    <div class="page-footer">
      <div class="footer-column">
        <p class="company-name">ExposeProfi.de</p>
        <p>EPCS GmbH</p>
        <p>GF: Christopher Helm</p>
        <p>Bruder-Klaus-Str. 3a, 78467 Konstanz</p>
        <p>HRB 725172, Amtsgericht Freiburg</p>
        <p>St.-Nr: 0908011277</p>
        <p>USt-ID: DE347265281</p>
      </div>

      <div class="footer-column">
        <p class="company-name">Bankverbindung</p>
        <p>Qonto (Banque de France)</p>
        <p>IBAN DE62100101239488471916</p>
      </div>

      <div class="footer-column">
        <p>Email: christopher.helm@exposeprofi.de</p>
        <p>Web: www.exposeprofi.de</p>
        <p>Tel: +49-7531-1227491</p>
      </div>
    </div>
  </div>

  <!-- ========================================
       PAGE 1: SERVICES TABLE
       ======================================== -->
  <div class="page">
    <div class="page-content">
      <!-- Header -->
      <div class="header-text">
        <strong>Basierend auf den zugesandten Unterlagen unterbreiten wir Ihnen folgendes Angebot:</strong>
      </div>

      <!-- Dynamic Services Table -->
      <table id="servicesTable">
        <thead>
          <tr>
            <th class="col-number">Anzahl</th>
            <th class="col-designation">Bezeichnung</th>
            <th class="col-description">Beschreibung</th>
            <th class="col-price">St√ºckpreis netto</th>
          </tr>
        </thead>
        <tbody id="servicesTableBody">
          <tr>
            <td colspan="4" class="empty-state">No services selected. Please select services in the form.</td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Footer -->
    <div class="page-footer">
      <div class="footer-column">
        <p class="company-name">ExposeProfi.de</p>
        <p>EPCS GmbH</p>
        <p>GF: Christopher Helm</p>
        <p>Bruder-Klaus-Str. 3a, 78467 Konstanz</p>
        <p>HRB 725172, Amtsgericht Freiburg</p>
        <p>St.-Nr: 0908011277</p>
        <p>USt-ID: DE347265281</p>
      </div>

      <div class="footer-column">
        <p class="company-name">Bankverbindung</p>
        <p>Qonto (Banque de France)</p>
        <p>IBAN DE62100101239488471916</p>
      </div>

      <div class="footer-column">
        <p>Email: christopher.helm@exposeprofi.de</p>
        <p>Web: www.exposeprofi.de</p>
        <p>Tel: +49-7531-1227491</p>
      </div>
    </div>
  </div>

  <!-- ========================================
       PAGE 2: PERSPECTIVE IMAGES
       ======================================== -->
  <div class="page" id="perspectiveImagesPage" style="display: none;">
    <div class="page-content">
      <!-- RECOMMENDED PERSPECTIVES -->
      <div class="section-title">Empfohlene Perspektiven Au√üen:</div>
      <div id="perspectiveImagesContainer">
        <!-- Images will be inserted here -->
      </div>
    </div>

    <!-- Footer -->
    <div class="page-footer">
      <div class="footer-column">
        <p class="company-name">ExposeProfi.de</p>
        <p>EPCS GmbH</p>
        <p>GF: Christopher Helm</p>
        <p>Bruder-Klaus-Str. 3a, 78467 Konstanz</p>
        <p>HRB 725172, Amtsgericht Freiburg</p>
        <p>St.-Nr: 0908011277</p>
        <p>USt-ID: DE347265281</p>
      </div>

      <div class="footer-column">
        <p class="company-name">Bankverbindung</p>
        <p>Qonto (Banque de France)</p>
        <p>IBAN DE62100101239488471916</p>
      </div>

      <div class="footer-column">
        <p>Email: christopher.helm@exposeprofi.de</p>
        <p>Web: www.exposeprofi.de</p>
        <p>Tel: +49-7531-1227491</p>
      </div>
    </div>
  </div>

  <!-- ========================================
       PAGE 3: PRICING SUMMARY (LAST PAGE)
       ======================================== -->
  <div class="page">
    <div class="page-content">
      <!-- PRICING SUMMARY -->
      <div class="section-title">Zusammenfassung:</div>
      <table class="pricing-summary">
        <tbody id="summary-tbody">
          <tr class="summary-row">
            <td class="summary-label"><strong>Zwischensumme (Netto)</strong></td>
            <td class="summary-value"><strong><span class="editable" contenteditable="true" id="preview-subtotalNet" data-field="subtotalNet">0,00 ‚Ç¨</span></strong></td>
          </tr>
          <!-- Discount row will be inserted here if added -->
          <tr class="summary-row" id="vat-row">
            <td class="summary-label"><strong><span class="editable" contenteditable="true" data-field="vatLabel">MwSt. (19%)</span></strong></td>
            <td class="summary-value"><strong><span class="editable" contenteditable="true" id="preview-totalVat" data-field="totalVat">0,00 ‚Ç¨</span></strong></td>
          </tr>
          <tr class="summary-row">
            <td class="summary-label"><strong>Gesamtbruttopreis</strong></td>
            <td class="summary-value"><strong><span class="editable" contenteditable="true" id="preview-totalGross" data-field="totalGross">0,00 ‚Ç¨</span></strong></td>
          </tr>
        </tbody>
      </table>
      <button class="add-discount-btn" onclick="addDiscountRow()" id="add-discount-btn">+ Rabatt hinzuf√ºgen</button>
      <div class="edit-hint" style="margin-top: 5px;">Preise und Bezeichnungen sind editierbar - klicken Sie zum Bearbeiten</div>
      
      <p style="margin-top: 32px; margin-bottom: 20px;">
        <strong><span class="editable-text" contenteditable="true" data-field="validUntilText">Dieses Angebot ist g√ºltig bis:</span> <span class="editable" contenteditable="true" id="preview-validUntil" data-field="validUntil"></span></strong>
      </p>

      <!-- DELIVERY AND TERMS -->
      <div style="margin-bottom: 20px;">
        <p><strong>Lieferweg:</strong> <span class="editable-text" contenteditable="true" data-field="deliveryMethod">Digital via Email</span></p>
        <p><strong>Lieferzeit:</strong> <span class="editable" contenteditable="true" id="preview-deliveryDays" data-field="deliveryDays"></span> <span class="editable-text" contenteditable="true" data-field="deliveryDaysText">Werktage ab Beauftragung und Erhalt der Unterlagen</span></p>
      </div>

      <div style="margin-bottom: 20px;">
        <p><strong>Zahlungsbedingungen:</strong> <span class="editable-text" contenteditable="true" data-field="paymentTerms">50% Anzahlung, Rest nach Lieferung - innerhalb 14 Tage netto</span></p>
      </div>

      <p style="margin-bottom: 20px; font-style: italic;">
        <span class="editable-text" contenteditable="true" data-field="closingGreeting">Mit freundlichen Gr√º√üen</span><br>
        <span class="editable" contenteditable="true" id="preview-signatureName" data-field="signatureName">Christopher Helm</span>
      </p>

      <!-- FOOTNOTES -->
      <div class="footnote">
        <p><strong>Hinweise:</strong></p>
        <p>‚Ä¢ <span class="editable-text" contenteditable="true" data-field="note1">Alle Preise verstehen sich in Euro zzgl. der gesetzlichen Mehrwertsteuer.</span></p>
        <p>‚Ä¢ <span class="editable-text" contenteditable="true" data-field="note2">Die Lieferzeit beginnt nach Auftragsbest√§tigung und Zahlungseingang der Anzahlung.</span></p>
      </div>

      <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #ccc; font-size: 11px; line-height: 1.6;">
        <p><strong>Korrekturschleifen:</strong> <span class="editable-text" contenteditable="true" data-field="revisionPolicy">Bis zu 2 Korrekturschleifen sind im Preis inbegriffen. Weitere Korrekturschleifen werden nach Aufwand berechnet.</span></p>
        <p><strong>Nutzungsrechte:</strong> <span class="editable-text" contenteditable="true" data-field="usageRights">Mit vollst√§ndiger Bezahlung erhalten Sie die uneingeschr√§nkten Nutzungsrechte an den gelieferten Visualisierungen.</span></p>
      </div>
    </div>

    <!-- Footer -->
    <div class="page-footer">
      <div class="footer-column">
        <p class="company-name">ExposeProfi.de</p>
        <p>EPCS GmbH</p>
        <p>GF: Christopher Helm</p>
        <p>Bruder-Klaus-Str. 3a, 78467 Konstanz</p>
        <p>HRB 725172, Amtsgericht Freiburg</p>
        <p>St.-Nr: 0908011277</p>
        <p>USt-ID: DE347265281</p>
      </div>

      <div class="footer-column">
        <p class="company-name">Bankverbindung</p>
        <p>Qonto (Banque de France)</p>
        <p>IBAN DE62100101239488471916</p>
      </div>

      <div class="footer-column">
        <p>Email: christopher.helm@exposeprofi.de</p>
        <p>Web: www.exposeprofi.de</p>
        <p>Tel: +49-7531-1227491</p>
      </div>
    </div>
  </div>

  <script>
    // Service descriptions mapping
    const serviceDescriptions = {
      'exterior-ground': {
        name: '3D-Au√üenvisualisierung Bodenperspektive',
        defaultPrice: 450.00,
        description: [
          {
            text: 'Fotorealistische 3D-Visualisierung aus Bodenperspektive',
            children: [
              {
                text: 'Ideal f√ºr Fassaden- und Eingangsbereichsdarstellung',
                children: [
                  'Maximale Detailgenauigkeit bei Materialien',
                  'Realistische Licht- und Schatteneffekte'
                ]
              },
              {
                text: 'Hervorhebung von Materialien und Texturen',
                children: [
                  'Holz, Stein, Glas und Metall',
                  'Wetterbest√§ndige Oberfl√§chen'
                ]
              },
              'Betont architektonische Details',
              'Zeigt Interaktion mit Umgebung'
            ]
          },
          'Hochaufl√∂sende Darstellung (min. 3000px)',
          'Professionelle Lichtsetzung und Materialisierung',
          'Umgebungsgestaltung mit Vegetation und Kontext'
        ]
      },
      'exterior-bird': {
        name: '3D-Au√üenvisualisierung Vogelperspektive',
        defaultPrice: 350.00,
        description: [
          'Fotorealistische Vogelperspektive',
          'Ideal f√ºr Gesamt√ºbersicht des Projekts',
          'Nur in Kombination mit Bodenperspektiven'
        ]
      },
      '3d-floorplan': {
        name: '3D-Grundriss',
        defaultPrice: 299.00,
        description: [
          'Fotorealistischer 3D-Grundriss',
          'M√∂blierte Darstellung',
          'Hochaufl√∂sende Qualit√§t'
        ]
      },
      '3d-complete-floor': {
        name: '3D-Geschossansicht',
        description: [
          'Komplette 3D-Ansicht eines Geschosses',
          'Alle Wohnungen in einem Geschoss',
          'M√∂blierte Darstellung'
        ]
      },
      '2d-floorplan': {
        name: '2D-Grundriss',
        description: [
          'Professioneller 2D-Grundriss',
          'Bema√üung und Fl√§chenangaben',
          'Druckfertige Qualit√§t'
        ]
      },
      'home-staging': {
        name: 'Digital Home Staging',
        defaultPrice: 89.00,
        description: [
          'Digitale M√∂blierung leerer R√§ume',
          'Fotorealistische Integration',
          'Verschiedene Einrichtungsstile'
        ]
      },
      'renovation': {
        name: 'Digitale Renovierung',
        description: [
          'Digitale Aufbereitung alter R√§ume',
          'Visualisierung von Renovierungspotential',
          'Fotorealistische Darstellung'
        ]
      },
      '360-interior': {
        name: '360¬∞ Tour Innen',
        description: [
          'Interaktive 360¬∞ Innenraumtour',
          'Navigation durch alle R√§ume',
          'Einbettbar auf Website'
        ]
      },
      '360-exterior': {
        name: '360¬∞ Video Au√üen',
        description: [
          '360¬∞ Au√üenansicht Video',
          'Nur mit min. 2x 3D-Au√üenvisualisierung',
          'Preis auf Anfrage'
        ]
      },
      'slideshow': {
        name: 'Slideshow Video',
        description: [
          'Professionelles Slideshow-Video',
          'Musik und √úberg√§nge',
          'Ideal f√ºr Social Media'
        ]
      },
      'site-plan': {
        name: '3D-Lageplan',
        description: [
          '3D-Darstellung der Lage',
          'Umgebungskontext',
          'Verkehrsanbindung'
        ]
      },
      'social-media': {
        name: 'Social Media Paket',
        description: [
          'Optimierte Bilder f√ºr Social Media',
          'Verschiedene Formate',
          'Stories und Posts'
        ]
      },
      'interior': {
        name: '3D-Innenvisualisierung',
        description: [
          'Fotorealistische Innenraumvisualisierung',
          'Hochaufl√∂sende Darstellung',
          'Professionelle Lichtsetzung',
          'Verschiedene Perspektiven m√∂glich'
        ],
        pricingTiers: [
          { quantity: 1, price: 399.00, label: '1 Ansicht Netto: 399,00 ‚Ç¨' },
          { quantity: 2, price: 299.00, label: '2 Ansichten: Netto pro Ansicht: 299,00 ‚Ç¨' },
          { quantity: 3, price: 289.00, label: '3 Ansichten: Netto pro Ansicht: 289,00 ‚Ç¨' },
          { quantity: 4, price: 269.00, label: '4 Ansichten: Netto pro Ansicht: 269,00 ‚Ç¨' },
          { quantity: 5, price: 259.00, label: '5 Ansichten: Netto pro Ansicht: 259,00 ‚Ç¨' },
          { quantity: 6, price: 249.00, label: '6 Ansichten: Netto pro Ansicht: 249,00 ‚Ç¨' },
          { quantity: 7, price: 239.00, label: '7 Ansichten: Netto pro Ansicht: 239,00 ‚Ç¨' },
          { quantity: 8, price: 229.00, label: '8 Ansichten: Netto pro Ansicht: 229,00 ‚Ç¨' },
          { quantity: 9, price: 219.00, label: '9 Ansichten: Netto pro Ansicht: 219,00 ‚Ç¨' },
          { quantity: 10, price: 199.00, label: '>=10 Ansichten: Netto pro Ansicht: 199,00 ‚Ç¨' }
        ]
      },
      'terrace': {
        name: '3D-Visualisierung Terrasse',
        description: [
          'Fotorealistische Terrassenvisualisierung',
          'Mit M√∂blierung und Bepflanzung',
          'Preis auf Anfrage'
        ]
      }
    };

    // Load proposal data from localStorage
    function loadProposalData() {
      const data = JSON.parse(localStorage.getItem('proposalPreviewData') || '{}');
      
      if (!data.clientInfo) {
        alert('No proposal data found. Please fill out the form first.');
        window.location.href = 'proposal-form.html';
        return;
      }

      // Populate client info
      document.getElementById('preview-companyName').textContent = data.clientInfo.companyName;
      document.getElementById('preview-street').textContent = data.clientInfo.street;
      document.getElementById('preview-postalCode').textContent = data.clientInfo.postalCode;
      document.getElementById('preview-city').textContent = data.clientInfo.city;
      document.getElementById('preview-country').textContent = data.clientInfo.country;

      // Populate project info
      document.getElementById('preview-date').textContent = data.projectInfo.date;
      document.getElementById('preview-offerNumber').textContent = `2025-${data.projectInfo.MM}-${data.projectInfo.DD}-1`;
      document.getElementById('preview-validUntil').textContent = formatDate(data.projectInfo.offerValidUntil);
      document.getElementById('preview-deliveryDays').textContent = data.projectInfo.deliveryDays;

      // Populate pricing
      document.getElementById('preview-subtotalNet').textContent = data.pricing.totalNetPrice + ' ‚Ç¨';
      document.getElementById('preview-totalVat').textContent = data.pricing.totalVat + ' ‚Ç¨';
      document.getElementById('preview-totalGross').textContent = data.pricing.totalGrossPrice + ' ‚Ç¨';
      
      // Restore discount if it exists
      if (data.pricing.discount && data.pricing.discount.amount) {
        addDiscountRow(data.pricing.discount.description, data.pricing.discount.amount);
      }

      // Populate signature
      document.getElementById('preview-signatureName').textContent = data.signature.signatureName;

      // Populate services table
      populateServicesTable(data.services);

      // Populate perspective images
      if (data.images && data.images.length > 0) {
        populatePerspectiveImages(data.images);
      }

      // Store data globally for generate function
      window.proposalData = data;
    }

    // Populate perspective images section
    function populatePerspectiveImages(images) {
      if (!images || images.length === 0) return;

      const page = document.getElementById('perspectiveImagesPage');
      const container = document.getElementById('perspectiveImagesContainer');
      
      page.style.display = 'flex'; // Show the page
      container.innerHTML = ''; // Clear existing content

      images.forEach((image, index) => {
        const imageItem = document.createElement('div');
        imageItem.className = 'perspective-image-item';

        // Add title if provided
        if (image.title) {
          const title = document.createElement('div');
          title.className = 'perspective-image-title';
          title.textContent = image.title;
          imageItem.appendChild(title);
        }

        // Add description if provided
        if (image.description) {
          const description = document.createElement('div');
          description.className = 'perspective-image-description';
          description.textContent = image.description;
          imageItem.appendChild(description);
        }

        // Add image preview
        if (image.imageData) {
          const img = document.createElement('img');
          img.className = 'perspective-image-preview';
          img.src = image.imageData;
          img.alt = image.title || `Perspective Image ${index + 1}`;
          imageItem.appendChild(img);
        }

        container.appendChild(imageItem);
      });
    }

    // Populate services table dynamically
    function populateServicesTable(services) {
      const tbody = document.getElementById('servicesTableBody');
      tbody.innerHTML = '';

      if (!services || services.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="empty-state">Keine Dienste ausgew√§hlt.</td></tr>';
        return;
      }

      services.forEach((service, index) => {
        const serviceInfo = findServiceInfo(service.name);
        
        const row = document.createElement('tr');
        
        // Column 1: Quantity (editable)
        const cellQty = document.createElement('td');
        cellQty.className = 'col-number';
        const qtySpan = document.createElement('span');
        qtySpan.className = 'editable';
        qtySpan.contentEditable = 'true';
        qtySpan.textContent = service.quantity;
        qtySpan.dataset.serviceIndex = index;
        qtySpan.dataset.field = 'quantity';
        qtySpan.addEventListener('blur', updateServiceData);
        qtySpan.addEventListener('keydown', handleEnterKey);
        cellQty.appendChild(qtySpan);
        row.appendChild(cellQty);

        // Column 2: Designation
        const cellDesignation = document.createElement('td');
        cellDesignation.className = 'col-designation';
        cellDesignation.textContent = serviceInfo ? serviceInfo.name : service.name;
        row.appendChild(cellDesignation);

        // Column 3: Description (editable bullet points)
        const cellDescription = document.createElement('td');
        cellDescription.className = 'col-description';
        cellDescription.dataset.serviceIndex = index;
        
        // Use modifiedDefaults if available, otherwise use original defaults
        const defaultDescription = service.modifiedDefaults || (serviceInfo ? serviceInfo.description : []);
        const customDescription = service.customDescription || [];
        
        if (defaultDescription.length > 0 || customDescription.length > 0) {
          const ul = document.createElement('ul');
          ul.dataset.serviceIndex = index;
          
          // Add default bullets (now editable and deletable)
          defaultDescription.forEach((desc, descIndex) => {
            const li = createBulletItemRecursive(desc, index, `default-${descIndex}`, true, 0);
            ul.appendChild(li);
          });
          
          // Add custom bullets (deletable)
          customDescription.forEach((desc, descIndex) => {
            const li = createBulletItemRecursive(desc, index, `custom-${descIndex}`, true, 0);
            ul.appendChild(li);
          });
          
          cellDescription.appendChild(ul);
          
          // Add button to add new bullet
          const addBtn = document.createElement('button');
          addBtn.className = 'add-bullet-btn';
          addBtn.textContent = '+ Add bullet';
          addBtn.onclick = () => addNewBullet(index);
          cellDescription.appendChild(addBtn);
          
          const hint = document.createElement('div');
          hint.className = 'edit-hint';
          hint.textContent = 'Click to edit, use buttons to add/delete';
          cellDescription.appendChild(hint);
          
          // Add pricing information if available
          if (serviceInfo) {
            // Show pricing tiers if available
            if (serviceInfo.pricingTiers) {
              const pricingDiv = document.createElement('div');
              pricingDiv.className = 'pricing-tiers';
              
              const title = document.createElement('div');
              title.className = 'pricing-tiers-title';
              title.textContent = 'Preisstaffelung:';
              pricingDiv.appendChild(title);
              
              serviceInfo.pricingTiers.forEach(tier => {
                const tierItem = document.createElement('div');
                tierItem.className = 'pricing-tier-item';
                tierItem.textContent = tier.label;
                pricingDiv.appendChild(tierItem);
              });
              
              cellDescription.appendChild(pricingDiv);
            }
            // Show default price note if set and no tiers
            else if (serviceInfo.defaultPrice) {
              const priceNote = document.createElement('div');
              priceNote.className = 'pricing-tiers';
              priceNote.style.fontSize = '9pt';
              priceNote.innerHTML = `<strong>Standardpreis:</strong> ${serviceInfo.defaultPrice.toFixed(2)} ‚Ç¨ pro Einheit`;
              cellDescription.appendChild(priceNote);
            }
          }
        } else {
          cellDescription.textContent = 'Beschreibung nicht verf√ºgbar';
        }
        row.appendChild(cellDescription);

        // Column 4: Price (editable)
        const cellPrice = document.createElement('td');
        cellPrice.className = 'col-price';
        const priceSpan = document.createElement('span');
        priceSpan.className = 'editable';
        priceSpan.contentEditable = 'true';
        priceSpan.textContent = service.unitPrice;
        priceSpan.dataset.serviceIndex = index;
        priceSpan.dataset.field = 'unitPrice';
        priceSpan.addEventListener('blur', updateServiceData);
        priceSpan.addEventListener('keydown', handleEnterKey);
        cellPrice.appendChild(priceSpan);
        const euro = document.createTextNode(' ‚Ç¨');
        cellPrice.appendChild(euro);
        row.appendChild(cellPrice);

        tbody.appendChild(row);
      });
    }

    // Create bullet item recursively with up to 2 levels of nesting
    function createBulletItemRecursive(item, serviceIndex, bulletIndex, isDeletable, level) {
      const li = document.createElement('li');
      
      // Get the text (item could be string or object with text property)
      const text = typeof item === 'string' ? item : item.text;
      
      const bulletSpan = document.createElement('span');
      bulletSpan.className = 'editable-bullet';
      bulletSpan.contentEditable = 'true';
      bulletSpan.textContent = text;
      bulletSpan.dataset.serviceIndex = serviceIndex;
      bulletSpan.dataset.bulletIndex = bulletIndex;
      bulletSpan.dataset.level = level;
      bulletSpan.addEventListener('blur', updateBulletPoint);
      bulletSpan.addEventListener('keydown', handleEnterKey);
      li.appendChild(bulletSpan);
      
      // Add controls
      if (isDeletable) {
        const controls = document.createElement('span');
        controls.className = 'bullet-controls';
        
        // Add sub-bullet button (only if we're not at max depth of 3)
        if (level < 3) {
          const addSubBtn = document.createElement('button');
          addSubBtn.className = 'bullet-btn add-sub';
          addSubBtn.textContent = '+ Sub';
          addSubBtn.onclick = (e) => {
            e.stopPropagation();
            addSubBulletRecursive(serviceIndex, bulletIndex, level);
          };
          controls.appendChild(addSubBtn);
        }
        
        // Delete button
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'bullet-btn delete';
        deleteBtn.textContent = '‚úï';
        deleteBtn.onclick = (e) => {
          e.stopPropagation();
          deleteBulletRecursive(serviceIndex, bulletIndex, level);
        };
        controls.appendChild(deleteBtn);
        
        bulletSpan.appendChild(controls);
      }
      
      // Handle children (sub-bullets) recursively
      if (typeof item === 'object' && item.children && item.children.length > 0) {
        const subUl = document.createElement('ul');
        subUl.className = 'sub-bullet';
        
        item.children.forEach((childItem, childIndex) => {
          const childLi = createBulletItemRecursive(
            childItem,
            serviceIndex,
            `${bulletIndex}-${childIndex}`,
            isDeletable,
            level + 1
          );
          subUl.appendChild(childLi);
        });
        
        li.appendChild(subUl);
      }
      
      return li;
    }

    // Create bullet item with controls (legacy function - kept for compatibility)
    function createBulletItem(text, serviceIndex, bulletIndex, isDeletable, isSubBullet) {
      const li = document.createElement('li');
      
      const bulletSpan = document.createElement('span');
      bulletSpan.className = 'editable-bullet';
      bulletSpan.contentEditable = 'true';
      bulletSpan.textContent = text;
      bulletSpan.dataset.serviceIndex = serviceIndex;
      bulletSpan.dataset.bulletIndex = bulletIndex;
      bulletSpan.dataset.isSubBullet = isSubBullet;
      bulletSpan.addEventListener('blur', updateBulletPoint);
      bulletSpan.addEventListener('keydown', handleEnterKey);
      li.appendChild(bulletSpan);
      
      // Add controls for custom bullets
      if (isDeletable) {
        const controls = document.createElement('span');
        controls.className = 'bullet-controls';
        
        // Add sub-bullet button (only for main bullets, not sub-bullets)
        if (!isSubBullet) {
          const addSubBtn = document.createElement('button');
          addSubBtn.className = 'bullet-btn add-sub';
          addSubBtn.textContent = '+ Sub';
          addSubBtn.onclick = (e) => {
            e.stopPropagation();
            addSubBullet(serviceIndex, bulletIndex, li);
          };
          controls.appendChild(addSubBtn);
        }
        
        // Delete button
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'bullet-btn delete';
        deleteBtn.textContent = '‚úï';
        deleteBtn.onclick = (e) => {
          e.stopPropagation();
          deleteBullet(serviceIndex, bulletIndex, li, isSubBullet);
        };
        controls.appendChild(deleteBtn);
        
        bulletSpan.appendChild(controls);
      }
      
      return li;
    }

    // Add new bullet point to a service
    function addNewBullet(serviceIndex) {
      const service = window.proposalData.services[serviceIndex];
      
      if (!service.customDescription) {
        service.customDescription = [];
      }
      
      service.customDescription.push('New bullet point');
      
      // Update localStorage
      localStorage.setItem('proposalData', JSON.stringify(window.proposalData));
      
      // Re-render the table
      populateServicesTable(window.proposalData.services);
    }

    // Add sub-bullet to a bullet point
    function addSubBullet(serviceIndex, bulletIndex, parentLi) {
      const service = window.proposalData.services[serviceIndex];
      const serviceInfo = findServiceInfo(service.name);
      const defaultLength = serviceInfo ? serviceInfo.description.length : 0;
      const customIndex = bulletIndex - defaultLength;
      
      if (!service.customDescription) {
        service.customDescription = [];
      }
      
      // Convert string to object with children if needed
      const currentBullet = service.customDescription[customIndex];
      if (typeof currentBullet === 'string') {
        service.customDescription[customIndex] = {
          text: currentBullet,
          children: ['New sub-point']
        };
      } else if (currentBullet && currentBullet.children) {
        currentBullet.children.push('New sub-point');
      }
      
      // Update localStorage
      localStorage.setItem('proposalData', JSON.stringify(window.proposalData));
      
      // Re-render the table
      populateServicesTable(window.proposalData.services);
    }

    // Add sub-bullet recursively (supports 3 levels)
    function addSubBulletRecursive(serviceIndex, bulletIndex, currentLevel) {
      if (currentLevel >= 3) {
        alert('Maximum nesting level (3) reached. Cannot add more sub-bullets.');
        return;
      }

      const service = window.proposalData.services[serviceIndex];
      const serviceInfo = findServiceInfo(service.name);
      
      const pathParts = bulletIndex.split('-');
      const isDefault = pathParts[0] === 'default';
      const isCustom = pathParts[0] === 'custom';
      
      if (isDefault) {
        // Copy defaults to modifiedDefaults if not already done
        if (!service.modifiedDefaults) {
          service.modifiedDefaults = JSON.parse(JSON.stringify(serviceInfo ? serviceInfo.description : []));
        }
        
        const indices = pathParts.slice(1).map(Number);
        let target = service.modifiedDefaults;
        
        // Navigate to the parent bullet
        for (let i = 0; i < indices.length; i++) {
          const idx = indices[i];
          
          if (i === indices.length - 1) {
            // This is the target bullet
            if (typeof target[idx] === 'string') {
              target[idx] = {
                text: target[idx],
                children: ['New sub-point']
              };
            } else if (target[idx].children) {
              target[idx].children.push('New sub-point');
            } else {
              target[idx].children = ['New sub-point'];
            }
          } else {
            // Navigate deeper
            if (typeof target[idx] === 'object' && target[idx].children) {
              target = target[idx].children;
            }
          }
        }
        
        localStorage.setItem('proposalData', JSON.stringify(window.proposalData));
        populateServicesTable(window.proposalData.services);
        return;
      }
      
      if (isCustom) {
        if (!service.customDescription) {
          service.customDescription = [];
        }
        
        const indices = pathParts.slice(1).map(Number);
        let target = service.customDescription;
        
        // Navigate to the parent bullet
        for (let i = 0; i < indices.length; i++) {
          const idx = indices[i];
          
          if (i === indices.length - 1) {
            // This is the target bullet
            if (typeof target[idx] === 'string') {
              // Convert string to object with children
              target[idx] = {
                text: target[idx],
                children: ['New sub-point']
              };
            } else if (target[idx].children) {
              // Add to existing children
              target[idx].children.push('New sub-point');
            } else {
              // Initialize children array
              target[idx].children = ['New sub-point'];
            }
          } else {
            // Navigate deeper
            if (typeof target[idx] === 'object' && target[idx].children) {
              target = target[idx].children;
            }
          }
        }
      }
      
      localStorage.setItem('proposalData', JSON.stringify(window.proposalData));
      populateServicesTable(window.proposalData.services);
    }

    // Delete bullet recursively
    function deleteBulletRecursive(serviceIndex, bulletIndex, level) {
      if (!confirm('Delete this bullet point?')) return;
      
      const service = window.proposalData.services[serviceIndex];
      const serviceInfo = findServiceInfo(service.name);
      
      const pathParts = bulletIndex.split('-');
      const isDefault = pathParts[0] === 'default';
      const isCustom = pathParts[0] === 'custom';
      
      if (isDefault) {
        // Copy defaults to modifiedDefaults if not already done, then delete
        if (!service.modifiedDefaults) {
          service.modifiedDefaults = JSON.parse(JSON.stringify(serviceInfo ? serviceInfo.description : []));
        }
        
        const indices = pathParts.slice(1).map(Number);
        
        if (indices.length === 1) {
          // Top-level default bullet
          service.modifiedDefaults.splice(indices[0], 1);
        } else {
          // Nested bullet - navigate to parent
          let target = service.modifiedDefaults;
          
          for (let i = 0; i < indices.length - 1; i++) {
            const idx = indices[i];
            if (typeof target[idx] === 'object' && target[idx].children) {
              if (i === indices.length - 2) {
                // Parent of the target
                target[idx].children.splice(indices[indices.length - 1], 1);
                
                // If no more children, convert back to string
                if (target[idx].children.length === 0) {
                  target[idx] = target[idx].text;
                }
              } else {
                target = target[idx].children;
              }
            }
          }
        }
        
        localStorage.setItem('proposalData', JSON.stringify(window.proposalData));
        populateServicesTable(window.proposalData.services);
        return;
      }
      
      if (isCustom) {
        const indices = pathParts.slice(1).map(Number);
        
        if (indices.length === 1) {
          // Top-level custom bullet
          service.customDescription.splice(indices[0], 1);
        } else {
          // Nested bullet - navigate to parent
          let target = service.customDescription;
          
          for (let i = 0; i < indices.length - 1; i++) {
            const idx = indices[i];
            if (typeof target[idx] === 'object' && target[idx].children) {
              if (i === indices.length - 2) {
                // Parent of the target
                target[idx].children.splice(indices[indices.length - 1], 1);
                
                // If no more children, convert back to string
                if (target[idx].children.length === 0) {
                  target[idx] = target[idx].text;
                }
              } else {
                target = target[idx].children;
              }
            }
          }
        }
      }
      
      localStorage.setItem('proposalData', JSON.stringify(window.proposalData));
      populateServicesTable(window.proposalData.services);
    }

    // Delete a bullet point (legacy function - kept for compatibility)
    function deleteBullet(serviceIndex, bulletIndex, li, isSubBullet) {
      if (!confirm('Delete this bullet point?')) return;
      
      const service = window.proposalData.services[serviceIndex];
      const serviceInfo = findServiceInfo(service.name);
      const defaultLength = serviceInfo ? serviceInfo.description.length : 0;
      
      if (isSubBullet) {
        // Handle sub-bullet deletion
        const [parentIndex, subIndex] = bulletIndex.split('-').map(Number);
        const customIndex = parentIndex - defaultLength;
        
        if (service.customDescription[customIndex] && service.customDescription[customIndex].children) {
          service.customDescription[customIndex].children.splice(subIndex, 1);
          
          // If no more children, convert back to string
          if (service.customDescription[customIndex].children.length === 0) {
            service.customDescription[customIndex] = service.customDescription[customIndex].text;
          }
        }
      } else {
        // Handle main bullet deletion
        const customIndex = bulletIndex - defaultLength;
        service.customDescription.splice(customIndex, 1);
      }
      
      // Update localStorage
      localStorage.setItem('proposalData', JSON.stringify(window.proposalData));
      
      // Re-render the table
      populateServicesTable(window.proposalData.services);
    }

    // Update service data when field is edited
    function updateServiceData(event) {
      const span = event.target;
      const serviceIndex = parseInt(span.dataset.serviceIndex);
      const field = span.dataset.field;
      const newValue = span.textContent.trim();
      
      if (window.proposalData && window.proposalData.services[serviceIndex]) {
        const service = window.proposalData.services[serviceIndex];
        
        if (field === 'quantity') {
          const quantity = parseInt(newValue) || 1;
          service.quantity = quantity;
          
          // Only auto-update price if user hasn't manually set a custom price
          if (!service.customPriceSet) {
            const serviceInfo = findServiceInfo(service.name);
            
            // Priority: 1. Pricing tiers, 2. Default price, 3. Keep existing
            if (serviceInfo && serviceInfo.pricingTiers) {
              const tierPrice = getPriceForQuantity(serviceInfo.pricingTiers, quantity);
              if (tierPrice !== null) {
                service.unitPrice = tierPrice;
                // Update the price display
                const priceCell = span.closest('tr').querySelector('[data-field="unitPrice"]');
                if (priceCell) {
                  priceCell.textContent = tierPrice;
                }
              }
            } else if (serviceInfo && serviceInfo.defaultPrice) {
              // Use default price if no tiers exist
              service.unitPrice = serviceInfo.defaultPrice;
              const priceCell = span.closest('tr').querySelector('[data-field="unitPrice"]');
              if (priceCell) {
                priceCell.textContent = serviceInfo.defaultPrice;
              }
            }
          }
        } else if (field === 'unitPrice') {
          const price = parseFloat(newValue) || 0;
          service.unitPrice = price;
          service.customPriceSet = true; // Mark that user manually set the price
        }
        
        // Update localStorage
        localStorage.setItem('proposalData', JSON.stringify(window.proposalData));
        console.log(`Updated ${field} for service ${serviceIndex}:`, newValue);
      }
    }

    // Get price based on quantity from pricing tiers
    function getPriceForQuantity(pricingTiers, quantity) {
      if (!pricingTiers || pricingTiers.length === 0) return null;
      
      // Find the appropriate tier
      for (let i = pricingTiers.length - 1; i >= 0; i--) {
        if (quantity >= pricingTiers[i].quantity) {
          return pricingTiers[i].price;
        }
      }
      
      // Default to first tier if quantity is less than minimum
      return pricingTiers[0].price;
    }

    // Update bullet point when edited
    function updateBulletPoint(event) {
      const span = event.target;
      const serviceIndex = parseInt(span.dataset.serviceIndex);
      const bulletIndex = span.dataset.bulletIndex;
      const level = parseInt(span.dataset.level) || 0;
      const newValue = span.textContent.replace(/[+‚úï].*$/g, '').trim(); // Remove control buttons from text
      
      if (window.proposalData && window.proposalData.services[serviceIndex]) {
        const service = window.proposalData.services[serviceIndex];
        const serviceInfo = findServiceInfo(service.name);
        
        const pathParts = bulletIndex.split('-');
        const isDefault = pathParts[0] === 'default';
        const isCustom = pathParts[0] === 'custom';
        
        if (isDefault) {
          // Allow editing default bullets - copy to modifiedDefaults
          if (!service.modifiedDefaults) {
            service.modifiedDefaults = JSON.parse(JSON.stringify(serviceInfo ? serviceInfo.description : []));
          }
          
          const indices = pathParts.slice(1).map(Number);
          let target = service.modifiedDefaults;
          
          // Navigate to the target bullet
          for (let i = 0; i < indices.length; i++) {
            const idx = indices[i];
            
            if (i === indices.length - 1) {
              // This is the target bullet - update it
              if (typeof target[idx] === 'object' && target[idx].text !== undefined) {
                target[idx].text = newValue;
              } else {
                target[idx] = newValue;
              }
            } else {
              // Navigate deeper
              if (typeof target[idx] === 'object' && target[idx].children) {
                target = target[idx].children;
              }
            }
          }
          
          localStorage.setItem('proposalData', JSON.stringify(window.proposalData));
          console.log(`Updated default bullet ${bulletIndex} for service ${serviceIndex}:`, newValue);
          return;
        }
        
        if (isCustom) {
          if (!service.customDescription) {
            service.customDescription = [];
          }
          
          const indices = pathParts.slice(1).map(Number);
          let target = service.customDescription;
          
          // Navigate to the target bullet
          for (let i = 0; i < indices.length; i++) {
            const idx = indices[i];
            
            if (i === indices.length - 1) {
              // This is the target bullet - update it
              if (typeof target[idx] === 'object' && target[idx].text !== undefined) {
                target[idx].text = newValue;
              } else {
                target[idx] = newValue;
              }
            } else {
              // Navigate deeper
              if (typeof target[idx] === 'object' && target[idx].children) {
                target = target[idx].children;
              }
            }
          }
        }
        
        // Update localStorage
        localStorage.setItem('proposalData', JSON.stringify(window.proposalData));
        console.log(`Updated bullet ${bulletIndex} for service ${serviceIndex}:`, newValue);
      }
    }

    // Handle Enter key to blur (prevent line breaks)
    function handleEnterKey(event) {
      if (event.key === 'Enter') {
        event.preventDefault();
        event.target.blur();
      }
    }

    // Find service info by name
    function findServiceInfo(serviceName) {
      for (const [key, value] of Object.entries(serviceDescriptions)) {
        if (value.name === serviceName) {
          return value;
        }
      }
      return null;
    }

    // Format date to German format
    function formatDate(dateStr) {
      if (!dateStr) return '';
      const date = new Date(dateStr);
      return date.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit', year: '2-digit' });
    }

    // Add discount row
    function addDiscountRow(description = '', amount = '') {
      // Check if discount row already exists
      if (document.getElementById('discount-row')) {
        alert('Rabatt bereits hinzugef√ºgt. Bitte bearbeiten Sie den bestehenden Rabatt.');
        return;
      }

      const tbody = document.getElementById('summary-tbody');
      const vatRow = document.getElementById('vat-row');
      
      // Create discount row
      const discountRow = document.createElement('tr');
      discountRow.className = 'summary-row discount-row';
      discountRow.id = 'discount-row';
      
      discountRow.innerHTML = `
        <td class="summary-label">
          <strong>
            Rabatt: <span class="editable" contenteditable="true" id="discount-description" data-field="discountDescription">${description || 'Mengenrabatt'}</span>
          </strong>
        </td>
        <td class="summary-value">
          <strong>
            - <span class="editable" contenteditable="true" id="discount-amount" data-field="discountAmount">${amount || '0,00'}</span> ‚Ç¨
            <button class="remove-discount-btn" onclick="removeDiscountRow()">Entfernen</button>
          </strong>
        </td>
      `;
      
      // Insert before VAT row
      tbody.insertBefore(discountRow, vatRow);
      
      // Hide add button
      document.getElementById('add-discount-btn').style.display = 'none';
      
      // Save to proposalData
      if (window.proposalData) {
        if (!window.proposalData.pricing.discount) {
          window.proposalData.pricing.discount = {};
        }
        window.proposalData.pricing.discount.description = description || 'Mengenrabatt';
        window.proposalData.pricing.discount.amount = amount || '0,00';
        localStorage.setItem('proposalData', JSON.stringify(window.proposalData));
      }
      
      // Add event listeners for discount fields
      document.getElementById('discount-description').addEventListener('blur', updateDiscountData);
      document.getElementById('discount-amount').addEventListener('blur', updateDiscountData);
    }

    // Remove discount row
    function removeDiscountRow() {
      const discountRow = document.getElementById('discount-row');
      if (discountRow) {
        discountRow.remove();
      }
      
      // Show add button
      document.getElementById('add-discount-btn').style.display = 'block';
      
      // Remove from proposalData
      if (window.proposalData && window.proposalData.pricing.discount) {
        delete window.proposalData.pricing.discount;
        localStorage.setItem('proposalData', JSON.stringify(window.proposalData));
      }
    }

    // Update discount data
    function updateDiscountData(event) {
      const field = event.target.dataset.field;
      const value = event.target.textContent.trim();
      
      if (window.proposalData) {
        if (!window.proposalData.pricing.discount) {
          window.proposalData.pricing.discount = {};
        }
        
        if (field === 'discountDescription') {
          window.proposalData.pricing.discount.description = value;
        } else if (field === 'discountAmount') {
          window.proposalData.pricing.discount.amount = value;
        }
        
        localStorage.setItem('proposalData', JSON.stringify(window.proposalData));
      }
    }

    // Go back to form
    function goBack() {
      window.location.href = 'proposal-form.html';
    }

    // Generate proposal DOCX
    async function generateProposal() {
      const btn = document.getElementById('generateBtn');
      const originalText = btn.textContent;
      btn.textContent = '‚è≥ Generating...';
      btn.disabled = true;

      try {
        const data = window.proposalData;
        
        // Create FormData for file uploads
        const formData = new FormData();
        
        // Get image files from localStorage (stored during form submission)
        const imageFiles = JSON.parse(localStorage.getItem('proposalImageFiles') || '[]');
        
        // Reconstruct the data structure expected by the server
        const serverData = {
          clientInfo: data.clientInfo,
          projectInfo: data.projectInfo,
          services: data.services,
          pricing: data.pricing,
          signature: data.signature,
          images: data.images || []
        };
        
        formData.append('data', JSON.stringify(serverData));
        
        // Note: File objects cannot be stored in localStorage
        // In a real implementation, you would either:
        // 1. Re-upload files through the preview page
        // 2. Store files temporarily on the server
        // 3. Use IndexedDB for file storage
        
        console.log('Submitting proposal with data:', serverData);
        
        // Send to local server - use dynamic API URL from config
        const apiUrl = (window.APP_CONFIG?.API_URL || 'http://localhost:3000') + '/api/generate-proposal';
        
        const response = await fetch(apiUrl, {
          method: 'POST',
          body: formData
        });
        
        const result = await response.json();
        
        if (response.ok && result.success) {
          alert(`‚úÖ Proposal generated successfully!\n\nOffer Number: ${result.offerNumber}\nClient: ${result.clientName}\nTotal: ${result.totalAmount} ‚Ç¨`);
          console.log('Response:', result);
          
          // Download the file
          if (result.fileUrl) {
            const downloadUrl = (window.APP_CONFIG?.API_URL || 'http://localhost:3000') + result.fileUrl;
            window.open(downloadUrl, '_blank');
          }
        } else {
          throw new Error(result.error || 'Failed to generate proposal');
        }
      } catch (error) {
        console.error('Error:', error);
        alert(`‚ùå Error generating proposal:\n${error.message}\n\nMake sure the server is running (node proposal-server.js)`);
      } finally {
        // Reset button
        btn.textContent = originalText;
        btn.disabled = false;
      }
    }

    // Add event listeners for editable last page fields
    function initializeEditableFields() {
      // Handle editable-text fields (terms)
      document.querySelectorAll('.editable-text').forEach(field => {
        field.addEventListener('blur', function() {
          const fieldName = this.dataset.field;
          const newValue = this.textContent.trim();
          
          if (window.proposalData) {
            if (!window.proposalData.terms) {
              window.proposalData.terms = {};
            }
            
            window.proposalData.terms[fieldName] = newValue;
            localStorage.setItem('proposalData', JSON.stringify(window.proposalData));
            console.log(`Updated ${fieldName}:`, newValue);
          }
        });
        
        field.addEventListener('keydown', handleEnterKey);
      });

      // Handle summary editable fields (pricing)
      document.querySelectorAll('.pricing-summary .editable').forEach(field => {
        field.addEventListener('blur', function() {
          const fieldName = this.dataset.field;
          const newValue = this.textContent.trim();
          
          if (window.proposalData && window.proposalData.pricing) {
            if (fieldName === 'subtotalNet') {
              // Update the subtotal (remove ‚Ç¨ sign and spaces)
              const cleanValue = newValue.replace(/[‚Ç¨\s]/g, '');
              window.proposalData.pricing.totalNetPrice = cleanValue;
            } else if (fieldName === 'totalVat') {
              const cleanValue = newValue.replace(/[‚Ç¨\s]/g, '');
              window.proposalData.pricing.totalVat = cleanValue;
            } else if (fieldName === 'totalGross') {
              const cleanValue = newValue.replace(/[‚Ç¨\s]/g, '');
              window.proposalData.pricing.totalGrossPrice = cleanValue;
            } else if (fieldName === 'vatLabel') {
              if (!window.proposalData.pricing.vatLabel) {
                window.proposalData.pricing.vatLabel = {};
              }
              window.proposalData.pricing.vatLabel = newValue;
            }
            
            localStorage.setItem('proposalData', JSON.stringify(window.proposalData));
            console.log(`Updated pricing ${fieldName}:`, newValue);
          }
        });
        
        field.addEventListener('keydown', handleEnterKey);
      });

      // Handle other editable fields (validUntil, deliveryDays, signatureName)
      const specialEditables = {
        'preview-validUntil': 'projectInfo.offerValidUntil',
        'preview-deliveryDays': 'projectInfo.deliveryDays',
        'preview-signatureName': 'signature.signatureName'
      };

      Object.keys(specialEditables).forEach(id => {
        const element = document.getElementById(id);
        if (element) {
          element.addEventListener('blur', function() {
            const newValue = this.textContent.trim();
            const path = specialEditables[id].split('.');
            
            if (window.proposalData) {
              if (path.length === 2) {
                window.proposalData[path[0]][path[1]] = newValue;
              }
              
              localStorage.setItem('proposalData', JSON.stringify(window.proposalData));
              console.log(`Updated ${specialEditables[id]}:`, newValue);
            }
          });
          
          element.addEventListener('keydown', handleEnterKey);
        }
      });
    }

    // Load saved terms data
    function loadTermsData() {
      if (window.proposalData && window.proposalData.terms) {
        const terms = window.proposalData.terms;
        
        Object.keys(terms).forEach(key => {
          const field = document.querySelector(`[data-field="${key}"]`);
          if (field && terms[key]) {
            field.textContent = terms[key];
          }
        });
      }
    }

    // Load data on page load
    window.addEventListener('DOMContentLoaded', () => {
      loadProposalData();
      initializeEditableFields();
      loadTermsData();
    });
  </script>
</body>
</html>
